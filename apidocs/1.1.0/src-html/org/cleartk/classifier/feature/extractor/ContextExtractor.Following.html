<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    /*<a name="line.1"></a>
<FONT color="green">002</FONT>     * Copyright (c) 2011, Regents of the University of Colorado <a name="line.2"></a>
<FONT color="green">003</FONT>     * All rights reserved.<a name="line.3"></a>
<FONT color="green">004</FONT>     * <a name="line.4"></a>
<FONT color="green">005</FONT>     * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<FONT color="green">006</FONT>     * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<FONT color="green">007</FONT>     * <a name="line.7"></a>
<FONT color="green">008</FONT>     * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<FONT color="green">009</FONT>     * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<FONT color="green">010</FONT>     * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<FONT color="green">011</FONT>     * <a name="line.11"></a>
<FONT color="green">012</FONT>     * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<FONT color="green">013</FONT>     * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<FONT color="green">014</FONT>     * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<FONT color="green">015</FONT>     * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<FONT color="green">016</FONT>     * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<FONT color="green">017</FONT>     * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<FONT color="green">018</FONT>     * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<FONT color="green">019</FONT>     * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<FONT color="green">020</FONT>     * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<FONT color="green">021</FONT>     * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<FONT color="green">022</FONT>     * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<FONT color="green">023</FONT>     */<a name="line.23"></a>
<FONT color="green">024</FONT>    package org.cleartk.classifier.feature.extractor;<a name="line.24"></a>
<FONT color="green">025</FONT>    <a name="line.25"></a>
<FONT color="green">026</FONT>    import java.util.ArrayList;<a name="line.26"></a>
<FONT color="green">027</FONT>    import java.util.Arrays;<a name="line.27"></a>
<FONT color="green">028</FONT>    import java.util.Iterator;<a name="line.28"></a>
<FONT color="green">029</FONT>    import java.util.List;<a name="line.29"></a>
<FONT color="green">030</FONT>    <a name="line.30"></a>
<FONT color="green">031</FONT>    import org.apache.commons.lang.StringUtils;<a name="line.31"></a>
<FONT color="green">032</FONT>    import org.apache.uima.jcas.JCas;<a name="line.32"></a>
<FONT color="green">033</FONT>    import org.apache.uima.jcas.tcas.Annotation;<a name="line.33"></a>
<FONT color="green">034</FONT>    import org.cleartk.classifier.Feature;<a name="line.34"></a>
<FONT color="green">035</FONT>    import org.cleartk.classifier.feature.extractor.simple.SimpleFeatureExtractor;<a name="line.35"></a>
<FONT color="green">036</FONT>    import org.uimafit.util.JCasUtil;<a name="line.36"></a>
<FONT color="green">037</FONT>    <a name="line.37"></a>
<FONT color="green">038</FONT>    /**<a name="line.38"></a>
<FONT color="green">039</FONT>     * A feature extractor that finds other {@link Annotation}s in the context of a focus annotation and<a name="line.39"></a>
<FONT color="green">040</FONT>     * extracts features from these. It can be used, for example, to:<a name="line.40"></a>
<FONT color="green">041</FONT>     * &lt;ul&gt;<a name="line.41"></a>
<FONT color="green">042</FONT>     * &lt;li&gt;Get the text of the 2 tokens before a focus annotation&lt;/li&gt;<a name="line.42"></a>
<FONT color="green">043</FONT>     * &lt;li&gt;Get the parts of speech of the 3 tokens after a focus annotation&lt;/li&gt;<a name="line.43"></a>
<FONT color="green">044</FONT>     * &lt;li&gt;Get the tokens after a focus annotation, beginning 2 after and ending 5 after, as a bag of<a name="line.44"></a>
<FONT color="green">045</FONT>     * words&lt;/li&gt;<a name="line.45"></a>
<FONT color="green">046</FONT>     * &lt;li&gt;Get an ngram concatenating the stem of the first word before a focus annotation and the first<a name="line.46"></a>
<FONT color="green">047</FONT>     * word contained in the focus annotation&lt;/li&gt;<a name="line.47"></a>
<FONT color="green">048</FONT>     * &lt;li&gt;&lt;/li&gt;<a name="line.48"></a>
<FONT color="green">049</FONT>     * &lt;/ul&gt;<a name="line.49"></a>
<FONT color="green">050</FONT>     * <a name="line.50"></a>
<FONT color="green">051</FONT>     * &lt;br&gt;<a name="line.51"></a>
<FONT color="green">052</FONT>     * Copyright (c) 2011, Regents of the University of Colorado &lt;br&gt;<a name="line.52"></a>
<FONT color="green">053</FONT>     * All rights reserved.<a name="line.53"></a>
<FONT color="green">054</FONT>     * <a name="line.54"></a>
<FONT color="green">055</FONT>     * @author Steven Bethard<a name="line.55"></a>
<FONT color="green">056</FONT>     */<a name="line.56"></a>
<FONT color="green">057</FONT>    public class ContextExtractor&lt;T extends Annotation&gt; implements SimpleFeatureExtractor,<a name="line.57"></a>
<FONT color="green">058</FONT>        BetweenAnnotationsFeatureExtractor {<a name="line.58"></a>
<FONT color="green">059</FONT>    <a name="line.59"></a>
<FONT color="green">060</FONT>      private Class&lt;T&gt; annotationClass;<a name="line.60"></a>
<FONT color="green">061</FONT>    <a name="line.61"></a>
<FONT color="green">062</FONT>      private SimpleFeatureExtractor extractor;<a name="line.62"></a>
<FONT color="green">063</FONT>    <a name="line.63"></a>
<FONT color="green">064</FONT>      private Context[] contexts;<a name="line.64"></a>
<FONT color="green">065</FONT>    <a name="line.65"></a>
<FONT color="green">066</FONT>      /**<a name="line.66"></a>
<FONT color="green">067</FONT>       * Create an extractor that finds {@link Annotation}s of the given type at the specified<a name="line.67"></a>
<FONT color="green">068</FONT>       * {@link Context}s and applies the given feature extractor to the annotations.<a name="line.68"></a>
<FONT color="green">069</FONT>       * <a name="line.69"></a>
<FONT color="green">070</FONT>       * @param annotationClass<a name="line.70"></a>
<FONT color="green">071</FONT>       *          The type of annotation which should be searched for in the context.<a name="line.71"></a>
<FONT color="green">072</FONT>       * @param extractor<a name="line.72"></a>
<FONT color="green">073</FONT>       *          The feature extractor to apply to each annotation found.<a name="line.73"></a>
<FONT color="green">074</FONT>       * @param contexts<a name="line.74"></a>
<FONT color="green">075</FONT>       *          The contexts where the extractor should look for annotations.<a name="line.75"></a>
<FONT color="green">076</FONT>       */<a name="line.76"></a>
<FONT color="green">077</FONT>      public ContextExtractor(<a name="line.77"></a>
<FONT color="green">078</FONT>          Class&lt;T&gt; annotationClass,<a name="line.78"></a>
<FONT color="green">079</FONT>          SimpleFeatureExtractor extractor,<a name="line.79"></a>
<FONT color="green">080</FONT>          Context... contexts) {<a name="line.80"></a>
<FONT color="green">081</FONT>        this.annotationClass = annotationClass;<a name="line.81"></a>
<FONT color="green">082</FONT>        this.extractor = extractor;<a name="line.82"></a>
<FONT color="green">083</FONT>        this.contexts = contexts;<a name="line.83"></a>
<FONT color="green">084</FONT>      }<a name="line.84"></a>
<FONT color="green">085</FONT>    <a name="line.85"></a>
<FONT color="green">086</FONT>      @Override<a name="line.86"></a>
<FONT color="green">087</FONT>      public List&lt;Feature&gt; extract(JCas view, Annotation focusAnnotation)<a name="line.87"></a>
<FONT color="green">088</FONT>          throws CleartkExtractorException {<a name="line.88"></a>
<FONT color="green">089</FONT>        return this.extract(view, focusAnnotation, new NoBounds());<a name="line.89"></a>
<FONT color="green">090</FONT>      }<a name="line.90"></a>
<FONT color="green">091</FONT>    <a name="line.91"></a>
<FONT color="green">092</FONT>      /**<a name="line.92"></a>
<FONT color="green">093</FONT>       * Extract features from the annotations around the focus annotation and within the given bounds.<a name="line.93"></a>
<FONT color="green">094</FONT>       * <a name="line.94"></a>
<FONT color="green">095</FONT>       * @param view<a name="line.95"></a>
<FONT color="green">096</FONT>       *          The JCas containing the focus annotation.<a name="line.96"></a>
<FONT color="green">097</FONT>       * @param focusAnnotation<a name="line.97"></a>
<FONT color="green">098</FONT>       *          The annotation whose context is to be searched.<a name="line.98"></a>
<FONT color="green">099</FONT>       * @param boundsAnnotation<a name="line.99"></a>
<FONT color="green">100</FONT>       *          The boundary within which context annotations may be identified.<a name="line.100"></a>
<FONT color="green">101</FONT>       * @return The features extracted in the context of the focus annotation.<a name="line.101"></a>
<FONT color="green">102</FONT>       */<a name="line.102"></a>
<FONT color="green">103</FONT>      public List&lt;Feature&gt; extractWithin(<a name="line.103"></a>
<FONT color="green">104</FONT>          JCas view,<a name="line.104"></a>
<FONT color="green">105</FONT>          Annotation focusAnnotation,<a name="line.105"></a>
<FONT color="green">106</FONT>          Annotation boundsAnnotation) throws CleartkExtractorException {<a name="line.106"></a>
<FONT color="green">107</FONT>        Bounds bounds = new SpanBounds(boundsAnnotation.getBegin(), boundsAnnotation.getEnd());<a name="line.107"></a>
<FONT color="green">108</FONT>        return this.extract(view, focusAnnotation, bounds);<a name="line.108"></a>
<FONT color="green">109</FONT>      }<a name="line.109"></a>
<FONT color="green">110</FONT>    <a name="line.110"></a>
<FONT color="green">111</FONT>      @Override<a name="line.111"></a>
<FONT color="green">112</FONT>      public List&lt;Feature&gt; extractBetween(JCas view, Annotation annotation1, Annotation annotation2)<a name="line.112"></a>
<FONT color="green">113</FONT>          throws CleartkExtractorException {<a name="line.113"></a>
<FONT color="green">114</FONT>        int begin = annotation1.getEnd();<a name="line.114"></a>
<FONT color="green">115</FONT>        int end = annotation2.getBegin();<a name="line.115"></a>
<FONT color="green">116</FONT>        // FIXME: creating a new annotation may leak memory - is there a better approach?<a name="line.116"></a>
<FONT color="green">117</FONT>        Annotation focusAnnotation = new Annotation(view, begin, end);<a name="line.117"></a>
<FONT color="green">118</FONT>        return this.extract(view, focusAnnotation, new NoBounds());<a name="line.118"></a>
<FONT color="green">119</FONT>      }<a name="line.119"></a>
<FONT color="green">120</FONT>    <a name="line.120"></a>
<FONT color="green">121</FONT>      private List&lt;Feature&gt; extract(JCas view, Annotation focusAnnotation, Bounds bounds)<a name="line.121"></a>
<FONT color="green">122</FONT>          throws CleartkExtractorException {<a name="line.122"></a>
<FONT color="green">123</FONT>        List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.123"></a>
<FONT color="green">124</FONT>        for (Context context : this.contexts) {<a name="line.124"></a>
<FONT color="green">125</FONT>          features.addAll(context.extract(<a name="line.125"></a>
<FONT color="green">126</FONT>              view,<a name="line.126"></a>
<FONT color="green">127</FONT>              focusAnnotation,<a name="line.127"></a>
<FONT color="green">128</FONT>              bounds,<a name="line.128"></a>
<FONT color="green">129</FONT>              this.annotationClass,<a name="line.129"></a>
<FONT color="green">130</FONT>              this.extractor));<a name="line.130"></a>
<FONT color="green">131</FONT>        }<a name="line.131"></a>
<FONT color="green">132</FONT>        return features;<a name="line.132"></a>
<FONT color="green">133</FONT>      }<a name="line.133"></a>
<FONT color="green">134</FONT>    <a name="line.134"></a>
<FONT color="green">135</FONT>      /**<a name="line.135"></a>
<FONT color="green">136</FONT>       * A class representing the bounds within which a {@link ContextExtractor} should look for<a name="line.136"></a>
<FONT color="green">137</FONT>       * annotations.<a name="line.137"></a>
<FONT color="green">138</FONT>       */<a name="line.138"></a>
<FONT color="green">139</FONT>      public static interface Bounds {<a name="line.139"></a>
<FONT color="green">140</FONT>    <a name="line.140"></a>
<FONT color="green">141</FONT>        /**<a name="line.141"></a>
<FONT color="green">142</FONT>         * Determines whether or not an annotation lies within the given bounds.<a name="line.142"></a>
<FONT color="green">143</FONT>         * <a name="line.143"></a>
<FONT color="green">144</FONT>         * @param annotation<a name="line.144"></a>
<FONT color="green">145</FONT>         *          The annotation to be checked.<a name="line.145"></a>
<FONT color="green">146</FONT>         * @return True if the annotation lies within the bounds.<a name="line.146"></a>
<FONT color="green">147</FONT>         */<a name="line.147"></a>
<FONT color="green">148</FONT>        public boolean contains(Annotation annotation);<a name="line.148"></a>
<FONT color="green">149</FONT>      }<a name="line.149"></a>
<FONT color="green">150</FONT>    <a name="line.150"></a>
<FONT color="green">151</FONT>      /**<a name="line.151"></a>
<FONT color="green">152</FONT>       * A Bounds implementation that puts no restrictions on the context.<a name="line.152"></a>
<FONT color="green">153</FONT>       */<a name="line.153"></a>
<FONT color="green">154</FONT>      private static class NoBounds implements Bounds {<a name="line.154"></a>
<FONT color="green">155</FONT>    <a name="line.155"></a>
<FONT color="green">156</FONT>        public NoBounds() {<a name="line.156"></a>
<FONT color="green">157</FONT>        }<a name="line.157"></a>
<FONT color="green">158</FONT>    <a name="line.158"></a>
<FONT color="green">159</FONT>        @Override<a name="line.159"></a>
<FONT color="green">160</FONT>        public boolean contains(Annotation annotation) {<a name="line.160"></a>
<FONT color="green">161</FONT>          return true;<a name="line.161"></a>
<FONT color="green">162</FONT>        }<a name="line.162"></a>
<FONT color="green">163</FONT>    <a name="line.163"></a>
<FONT color="green">164</FONT>      }<a name="line.164"></a>
<FONT color="green">165</FONT>    <a name="line.165"></a>
<FONT color="green">166</FONT>      /**<a name="line.166"></a>
<FONT color="green">167</FONT>       * A Bounds implementation that restricts the context to annotations within a given span.<a name="line.167"></a>
<FONT color="green">168</FONT>       */<a name="line.168"></a>
<FONT color="green">169</FONT>      private static class SpanBounds implements Bounds {<a name="line.169"></a>
<FONT color="green">170</FONT>    <a name="line.170"></a>
<FONT color="green">171</FONT>        private int begin;<a name="line.171"></a>
<FONT color="green">172</FONT>    <a name="line.172"></a>
<FONT color="green">173</FONT>        private int end;<a name="line.173"></a>
<FONT color="green">174</FONT>    <a name="line.174"></a>
<FONT color="green">175</FONT>        public SpanBounds(int begin, int end) {<a name="line.175"></a>
<FONT color="green">176</FONT>          this.begin = begin;<a name="line.176"></a>
<FONT color="green">177</FONT>          this.end = end;<a name="line.177"></a>
<FONT color="green">178</FONT>        }<a name="line.178"></a>
<FONT color="green">179</FONT>    <a name="line.179"></a>
<FONT color="green">180</FONT>        @Override<a name="line.180"></a>
<FONT color="green">181</FONT>        public boolean contains(Annotation annotation) {<a name="line.181"></a>
<FONT color="green">182</FONT>          return annotation.getBegin() &gt;= this.begin &amp;&amp; annotation.getEnd() &lt;= this.end;<a name="line.182"></a>
<FONT color="green">183</FONT>        }<a name="line.183"></a>
<FONT color="green">184</FONT>    <a name="line.184"></a>
<FONT color="green">185</FONT>      }<a name="line.185"></a>
<FONT color="green">186</FONT>    <a name="line.186"></a>
<FONT color="green">187</FONT>      /**<a name="line.187"></a>
<FONT color="green">188</FONT>       * A class representing a location that a {@link ContextExtractor} should look for annotations.<a name="line.188"></a>
<FONT color="green">189</FONT>       */<a name="line.189"></a>
<FONT color="green">190</FONT>      public static interface Context {<a name="line.190"></a>
<FONT color="green">191</FONT>    <a name="line.191"></a>
<FONT color="green">192</FONT>        /**<a name="line.192"></a>
<FONT color="green">193</FONT>         * Gets the base feature name that will be used in {@link Feature}s generated by this context.<a name="line.193"></a>
<FONT color="green">194</FONT>         * The actual feature names may include additional information (e.g. relative position), but<a name="line.194"></a>
<FONT color="green">195</FONT>         * this base name should be used in all aggregating contexts like {@link Bag} or {@link Ngram}.<a name="line.195"></a>
<FONT color="green">196</FONT>         * <a name="line.196"></a>
<FONT color="green">197</FONT>         * @return The base feature name.<a name="line.197"></a>
<FONT color="green">198</FONT>         */<a name="line.198"></a>
<FONT color="green">199</FONT>        public String getName();<a name="line.199"></a>
<FONT color="green">200</FONT>    <a name="line.200"></a>
<FONT color="green">201</FONT>        /**<a name="line.201"></a>
<FONT color="green">202</FONT>         * Extracts features in the given context.<a name="line.202"></a>
<FONT color="green">203</FONT>         * <a name="line.203"></a>
<FONT color="green">204</FONT>         * @param jCas<a name="line.204"></a>
<FONT color="green">205</FONT>         *          The {@link JCas} containing the focus annotation.<a name="line.205"></a>
<FONT color="green">206</FONT>         * @param focusAnnotation<a name="line.206"></a>
<FONT color="green">207</FONT>         *          The annotation whose context is to be searched.<a name="line.207"></a>
<FONT color="green">208</FONT>         * @param annotationClass<a name="line.208"></a>
<FONT color="green">209</FONT>         *          The type of annotation to be found in the context.<a name="line.209"></a>
<FONT color="green">210</FONT>         * @param extractor<a name="line.210"></a>
<FONT color="green">211</FONT>         *          The feature extractor that should be applied to each annotation found in the<a name="line.211"></a>
<FONT color="green">212</FONT>         *          context.<a name="line.212"></a>
<FONT color="green">213</FONT>         * @return The list of features extracted.<a name="line.213"></a>
<FONT color="green">214</FONT>         */<a name="line.214"></a>
<FONT color="green">215</FONT>        public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.215"></a>
<FONT color="green">216</FONT>            JCas jCas,<a name="line.216"></a>
<FONT color="green">217</FONT>            Annotation focusAnnotation,<a name="line.217"></a>
<FONT color="green">218</FONT>            Bounds bounds,<a name="line.218"></a>
<FONT color="green">219</FONT>            Class&lt;T&gt; annotationClass,<a name="line.219"></a>
<FONT color="green">220</FONT>            SimpleFeatureExtractor extractor) throws CleartkExtractorException;<a name="line.220"></a>
<FONT color="green">221</FONT>      }<a name="line.221"></a>
<FONT color="green">222</FONT>    <a name="line.222"></a>
<FONT color="green">223</FONT>      /**<a name="line.223"></a>
<FONT color="green">224</FONT>       * A subclass of {@link Feature} that the base feature extractors wrap their features in. This<a name="line.224"></a>
<FONT color="green">225</FONT>       * enables aggregating contexts like {@link Bag} or {@link Ngram} to name their features properly.<a name="line.225"></a>
<FONT color="green">226</FONT>       */<a name="line.226"></a>
<FONT color="green">227</FONT>      private static class ContextFeature extends Feature {<a name="line.227"></a>
<FONT color="green">228</FONT>        public Feature feature;<a name="line.228"></a>
<FONT color="green">229</FONT>    <a name="line.229"></a>
<FONT color="green">230</FONT>        public ContextFeature(String baseName, Feature feature) {<a name="line.230"></a>
<FONT color="green">231</FONT>          this.feature = feature;<a name="line.231"></a>
<FONT color="green">232</FONT>          this.setName(Feature.createName(baseName, feature.getName()));<a name="line.232"></a>
<FONT color="green">233</FONT>          this.setValue(this.feature.getValue());<a name="line.233"></a>
<FONT color="green">234</FONT>        }<a name="line.234"></a>
<FONT color="green">235</FONT>    <a name="line.235"></a>
<FONT color="green">236</FONT>        public ContextFeature(String baseName, int position, Feature feature) {<a name="line.236"></a>
<FONT color="green">237</FONT>          this.feature = feature;<a name="line.237"></a>
<FONT color="green">238</FONT>          this.setName(Feature.createName(baseName, String.valueOf(position), feature.getName()));<a name="line.238"></a>
<FONT color="green">239</FONT>          this.setValue(feature.getValue());<a name="line.239"></a>
<FONT color="green">240</FONT>        }<a name="line.240"></a>
<FONT color="green">241</FONT>    <a name="line.241"></a>
<FONT color="green">242</FONT>        public ContextFeature(String baseName, int position, int oobPosition) {<a name="line.242"></a>
<FONT color="green">243</FONT>          this.feature = new Feature(null, String.format("OOB%d", oobPosition));<a name="line.243"></a>
<FONT color="green">244</FONT>          this.setName(Feature.createName(baseName, String.valueOf(position)));<a name="line.244"></a>
<FONT color="green">245</FONT>          this.setValue(this.feature.getValue());<a name="line.245"></a>
<FONT color="green">246</FONT>        }<a name="line.246"></a>
<FONT color="green">247</FONT>      }<a name="line.247"></a>
<FONT color="green">248</FONT>    <a name="line.248"></a>
<FONT color="green">249</FONT>      /**<a name="line.249"></a>
<FONT color="green">250</FONT>       * Base class for simple contexts that have a single begin and end.<a name="line.250"></a>
<FONT color="green">251</FONT>       */<a name="line.251"></a>
<FONT color="green">252</FONT>      private static abstract class Context_ImplBase implements Context {<a name="line.252"></a>
<FONT color="green">253</FONT>        protected int begin;<a name="line.253"></a>
<FONT color="green">254</FONT>    <a name="line.254"></a>
<FONT color="green">255</FONT>        protected int end;<a name="line.255"></a>
<FONT color="green">256</FONT>    <a name="line.256"></a>
<FONT color="green">257</FONT>        private String name;<a name="line.257"></a>
<FONT color="green">258</FONT>    <a name="line.258"></a>
<FONT color="green">259</FONT>        public Context_ImplBase(int begin, int end) {<a name="line.259"></a>
<FONT color="green">260</FONT>          if (begin &gt; end) {<a name="line.260"></a>
<FONT color="green">261</FONT>            String message = "expected begin &lt; end, found begin=%d end=%d";<a name="line.261"></a>
<FONT color="green">262</FONT>            throw new IllegalArgumentException(String.format(message, begin, end));<a name="line.262"></a>
<FONT color="green">263</FONT>          }<a name="line.263"></a>
<FONT color="green">264</FONT>          this.begin = begin;<a name="line.264"></a>
<FONT color="green">265</FONT>          this.end = end;<a name="line.265"></a>
<FONT color="green">266</FONT>          this.name = Feature.createName(<a name="line.266"></a>
<FONT color="green">267</FONT>              this.getClass().getSimpleName(),<a name="line.267"></a>
<FONT color="green">268</FONT>              String.valueOf(this.begin),<a name="line.268"></a>
<FONT color="green">269</FONT>              String.valueOf(this.end));<a name="line.269"></a>
<FONT color="green">270</FONT>        }<a name="line.270"></a>
<FONT color="green">271</FONT>    <a name="line.271"></a>
<FONT color="green">272</FONT>        @Override<a name="line.272"></a>
<FONT color="green">273</FONT>        public String getName() {<a name="line.273"></a>
<FONT color="green">274</FONT>          return this.name;<a name="line.274"></a>
<FONT color="green">275</FONT>        }<a name="line.275"></a>
<FONT color="green">276</FONT>    <a name="line.276"></a>
<FONT color="green">277</FONT>        /**<a name="line.277"></a>
<FONT color="green">278</FONT>         * Select annotations of the given type in the context of the focus annotation. The returned<a name="line.278"></a>
<FONT color="green">279</FONT>         * annotations should be in order (smaller begin/end offsets before larger begin/end offsets).<a name="line.279"></a>
<FONT color="green">280</FONT>         * <a name="line.280"></a>
<FONT color="green">281</FONT>         * @param jCas<a name="line.281"></a>
<FONT color="green">282</FONT>         *          The {@link JCas} containing the focus annotation.<a name="line.282"></a>
<FONT color="green">283</FONT>         * @param focusAnnotation<a name="line.283"></a>
<FONT color="green">284</FONT>         *          The annotation whose context is to be searched.<a name="line.284"></a>
<FONT color="green">285</FONT>         * @param annotationClass<a name="line.285"></a>
<FONT color="green">286</FONT>         *          The type of annotation to be found in the context.<a name="line.286"></a>
<FONT color="green">287</FONT>         * @param count<a name="line.287"></a>
<FONT color="green">288</FONT>         *          The number of annotations to select. A smaller number may be returned if it is not<a name="line.288"></a>
<FONT color="green">289</FONT>         *          possible to select the requested number.<a name="line.289"></a>
<FONT color="green">290</FONT>         * @return The annotations in the context of the focus annotation.<a name="line.290"></a>
<FONT color="green">291</FONT>         */<a name="line.291"></a>
<FONT color="green">292</FONT>        protected abstract &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.292"></a>
<FONT color="green">293</FONT>            JCas jCas,<a name="line.293"></a>
<FONT color="green">294</FONT>            Annotation focusAnnotation,<a name="line.294"></a>
<FONT color="green">295</FONT>            Class&lt;T&gt; annotationClass,<a name="line.295"></a>
<FONT color="green">296</FONT>            int count);<a name="line.296"></a>
<FONT color="green">297</FONT>      }<a name="line.297"></a>
<FONT color="green">298</FONT>    <a name="line.298"></a>
<FONT color="green">299</FONT>      /**<a name="line.299"></a>
<FONT color="green">300</FONT>       * Base class for simple contexts that scan their annotations from right to left.<a name="line.300"></a>
<FONT color="green">301</FONT>       */<a name="line.301"></a>
<FONT color="green">302</FONT>      private static abstract class RightToLeftContext extends Context_ImplBase {<a name="line.302"></a>
<FONT color="green">303</FONT>    <a name="line.303"></a>
<FONT color="green">304</FONT>        public RightToLeftContext(int begin, int end) {<a name="line.304"></a>
<FONT color="green">305</FONT>          super(begin, end);<a name="line.305"></a>
<FONT color="green">306</FONT>        }<a name="line.306"></a>
<FONT color="green">307</FONT>    <a name="line.307"></a>
<FONT color="green">308</FONT>        @Override<a name="line.308"></a>
<FONT color="green">309</FONT>        public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.309"></a>
<FONT color="green">310</FONT>            JCas jCas,<a name="line.310"></a>
<FONT color="green">311</FONT>            Annotation focusAnnotation,<a name="line.311"></a>
<FONT color="green">312</FONT>            Bounds bounds,<a name="line.312"></a>
<FONT color="green">313</FONT>            Class&lt;T&gt; annotationClass,<a name="line.313"></a>
<FONT color="green">314</FONT>            SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.314"></a>
<FONT color="green">315</FONT>    <a name="line.315"></a>
<FONT color="green">316</FONT>          // slice the appropriate annotations from the CAS<a name="line.316"></a>
<FONT color="green">317</FONT>          List&lt;T&gt; anns = this.select(jCas, focusAnnotation, annotationClass, this.end);<a name="line.317"></a>
<FONT color="green">318</FONT>          anns = anns.subList(0, anns.size() - this.begin);<a name="line.318"></a>
<FONT color="green">319</FONT>          int missing = this.end - this.begin - anns.size();<a name="line.319"></a>
<FONT color="green">320</FONT>    <a name="line.320"></a>
<FONT color="green">321</FONT>          // figure out how many items are out of bounds<a name="line.321"></a>
<FONT color="green">322</FONT>          int oobPos = missing;<a name="line.322"></a>
<FONT color="green">323</FONT>          for (T ann : anns) {<a name="line.323"></a>
<FONT color="green">324</FONT>            if (!bounds.contains(ann)) {<a name="line.324"></a>
<FONT color="green">325</FONT>              oobPos += 1;<a name="line.325"></a>
<FONT color="green">326</FONT>            }<a name="line.326"></a>
<FONT color="green">327</FONT>          }<a name="line.327"></a>
<FONT color="green">328</FONT>    <a name="line.328"></a>
<FONT color="green">329</FONT>          // extract features at each position<a name="line.329"></a>
<FONT color="green">330</FONT>          List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.330"></a>
<FONT color="green">331</FONT>          for (int pos = this.end - 1; pos &gt;= this.begin; pos -= 1) {<a name="line.331"></a>
<FONT color="green">332</FONT>    <a name="line.332"></a>
<FONT color="green">333</FONT>            // if the annotation at the current position is in bounds, extract features from it<a name="line.333"></a>
<FONT color="green">334</FONT>            int adjustedPos = this.end - 1 - pos - missing;<a name="line.334"></a>
<FONT color="green">335</FONT>            T ann = adjustedPos &gt;= 0 ? anns.get(adjustedPos) : null;<a name="line.335"></a>
<FONT color="green">336</FONT>            if (ann != null &amp;&amp; bounds.contains(ann)) {<a name="line.336"></a>
<FONT color="green">337</FONT>              for (Feature feature : extractor.extract(jCas, ann)) {<a name="line.337"></a>
<FONT color="green">338</FONT>                features.add(new ContextFeature(this.getName(), pos, feature));<a name="line.338"></a>
<FONT color="green">339</FONT>              }<a name="line.339"></a>
<FONT color="green">340</FONT>            }<a name="line.340"></a>
<FONT color="green">341</FONT>    <a name="line.341"></a>
<FONT color="green">342</FONT>            // if the annotation at the current position is out of bounds, add an out-of-bounds feature<a name="line.342"></a>
<FONT color="green">343</FONT>            else {<a name="line.343"></a>
<FONT color="green">344</FONT>              features.add(new ContextFeature(this.getName(), pos, oobPos));<a name="line.344"></a>
<FONT color="green">345</FONT>              oobPos -= 1;<a name="line.345"></a>
<FONT color="green">346</FONT>            }<a name="line.346"></a>
<FONT color="green">347</FONT>          }<a name="line.347"></a>
<FONT color="green">348</FONT>          return features;<a name="line.348"></a>
<FONT color="green">349</FONT>        }<a name="line.349"></a>
<FONT color="green">350</FONT>      }<a name="line.350"></a>
<FONT color="green">351</FONT>    <a name="line.351"></a>
<FONT color="green">352</FONT>      /**<a name="line.352"></a>
<FONT color="green">353</FONT>       * Base class for simple contexts that scan their annotations from left to right.<a name="line.353"></a>
<FONT color="green">354</FONT>       */<a name="line.354"></a>
<FONT color="green">355</FONT>      private static abstract class LeftToRightContext extends Context_ImplBase {<a name="line.355"></a>
<FONT color="green">356</FONT>    <a name="line.356"></a>
<FONT color="green">357</FONT>        public LeftToRightContext(int begin, int end) {<a name="line.357"></a>
<FONT color="green">358</FONT>          super(begin, end);<a name="line.358"></a>
<FONT color="green">359</FONT>        }<a name="line.359"></a>
<FONT color="green">360</FONT>    <a name="line.360"></a>
<FONT color="green">361</FONT>        @Override<a name="line.361"></a>
<FONT color="green">362</FONT>        public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.362"></a>
<FONT color="green">363</FONT>            JCas jCas,<a name="line.363"></a>
<FONT color="green">364</FONT>            Annotation focusAnnotation,<a name="line.364"></a>
<FONT color="green">365</FONT>            Bounds bounds,<a name="line.365"></a>
<FONT color="green">366</FONT>            Class&lt;T&gt; annotationClass,<a name="line.366"></a>
<FONT color="green">367</FONT>            SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.367"></a>
<FONT color="green">368</FONT>          List&lt;T&gt; anns = this.select(jCas, focusAnnotation, annotationClass, this.end);<a name="line.368"></a>
<FONT color="green">369</FONT>          anns = anns.subList(this.begin, anns.size());<a name="line.369"></a>
<FONT color="green">370</FONT>          List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.370"></a>
<FONT color="green">371</FONT>          Iterator&lt;T&gt; iter = anns.iterator();<a name="line.371"></a>
<FONT color="green">372</FONT>          for (int pos = this.begin, oobPos = 1; pos &lt; this.end; pos += 1) {<a name="line.372"></a>
<FONT color="green">373</FONT>            T ann = iter.hasNext() ? iter.next() : null;<a name="line.373"></a>
<FONT color="green">374</FONT>            if (ann != null &amp;&amp; bounds.contains(ann)) {<a name="line.374"></a>
<FONT color="green">375</FONT>              for (Feature feature : extractor.extract(jCas, ann)) {<a name="line.375"></a>
<FONT color="green">376</FONT>                features.add(new ContextFeature(this.getName(), pos, feature));<a name="line.376"></a>
<FONT color="green">377</FONT>              }<a name="line.377"></a>
<FONT color="green">378</FONT>            } else {<a name="line.378"></a>
<FONT color="green">379</FONT>              features.add(new ContextFeature(this.getName(), pos, oobPos));<a name="line.379"></a>
<FONT color="green">380</FONT>              oobPos += 1;<a name="line.380"></a>
<FONT color="green">381</FONT>            }<a name="line.381"></a>
<FONT color="green">382</FONT>          }<a name="line.382"></a>
<FONT color="green">383</FONT>          return features;<a name="line.383"></a>
<FONT color="green">384</FONT>        }<a name="line.384"></a>
<FONT color="green">385</FONT>      }<a name="line.385"></a>
<FONT color="green">386</FONT>    <a name="line.386"></a>
<FONT color="green">387</FONT>      /**<a name="line.387"></a>
<FONT color="green">388</FONT>       * A {@link Context} for extracting the focus annotation. This is mainly useful when the focus<a name="line.388"></a>
<FONT color="green">389</FONT>       * annotation should be combined with other annotations using, e.g. a {@link Bag} or {@link Ngram}<a name="line.389"></a>
<FONT color="green">390</FONT>       * to aggregate over several contexts.<a name="line.390"></a>
<FONT color="green">391</FONT>       */<a name="line.391"></a>
<FONT color="green">392</FONT>      public static class Focus implements Context {<a name="line.392"></a>
<FONT color="green">393</FONT>    <a name="line.393"></a>
<FONT color="green">394</FONT>        private String name;<a name="line.394"></a>
<FONT color="green">395</FONT>    <a name="line.395"></a>
<FONT color="green">396</FONT>        /**<a name="line.396"></a>
<FONT color="green">397</FONT>         * Constructs a context that will extract features over the focus annotation.<a name="line.397"></a>
<FONT color="green">398</FONT>         */<a name="line.398"></a>
<FONT color="green">399</FONT>        public Focus() {<a name="line.399"></a>
<FONT color="green">400</FONT>          this.name = this.getClass().getSimpleName();<a name="line.400"></a>
<FONT color="green">401</FONT>        }<a name="line.401"></a>
<FONT color="green">402</FONT>    <a name="line.402"></a>
<FONT color="green">403</FONT>        @Override<a name="line.403"></a>
<FONT color="green">404</FONT>        public String getName() {<a name="line.404"></a>
<FONT color="green">405</FONT>          return this.name;<a name="line.405"></a>
<FONT color="green">406</FONT>        }<a name="line.406"></a>
<FONT color="green">407</FONT>    <a name="line.407"></a>
<FONT color="green">408</FONT>        @Override<a name="line.408"></a>
<FONT color="green">409</FONT>        public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.409"></a>
<FONT color="green">410</FONT>            JCas jCas,<a name="line.410"></a>
<FONT color="green">411</FONT>            Annotation focusAnnotation,<a name="line.411"></a>
<FONT color="green">412</FONT>            Bounds bounds,<a name="line.412"></a>
<FONT color="green">413</FONT>            Class&lt;T&gt; annotationClass,<a name="line.413"></a>
<FONT color="green">414</FONT>            SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.414"></a>
<FONT color="green">415</FONT>          if (!annotationClass.isInstance(focusAnnotation)) {<a name="line.415"></a>
<FONT color="green">416</FONT>            String message = "%s is not an instance of %s";<a name="line.416"></a>
<FONT color="green">417</FONT>            throw new IllegalArgumentException(String.format(message, focusAnnotation, annotationClass));<a name="line.417"></a>
<FONT color="green">418</FONT>          }<a name="line.418"></a>
<FONT color="green">419</FONT>          List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.419"></a>
<FONT color="green">420</FONT>          for (Feature feature : extractor.extract(jCas, focusAnnotation)) {<a name="line.420"></a>
<FONT color="green">421</FONT>            features.add(new ContextFeature(this.getName(), feature));<a name="line.421"></a>
<FONT color="green">422</FONT>          }<a name="line.422"></a>
<FONT color="green">423</FONT>          return features;<a name="line.423"></a>
<FONT color="green">424</FONT>        }<a name="line.424"></a>
<FONT color="green">425</FONT>    <a name="line.425"></a>
<FONT color="green">426</FONT>      }<a name="line.426"></a>
<FONT color="green">427</FONT>    <a name="line.427"></a>
<FONT color="green">428</FONT>      /**<a name="line.428"></a>
<FONT color="green">429</FONT>       * A {@link Context} for extracting annotations appearing before the focus annotation.<a name="line.429"></a>
<FONT color="green">430</FONT>       */<a name="line.430"></a>
<FONT color="green">431</FONT>      public static class Preceding extends RightToLeftContext {<a name="line.431"></a>
<FONT color="green">432</FONT>    <a name="line.432"></a>
<FONT color="green">433</FONT>        /**<a name="line.433"></a>
<FONT color="green">434</FONT>         * Constructs a context that will extract features over the preceding N annotations.<a name="line.434"></a>
<FONT color="green">435</FONT>         * <a name="line.435"></a>
<FONT color="green">436</FONT>         * @param end<a name="line.436"></a>
<FONT color="green">437</FONT>         *          The number of annotations to extract.<a name="line.437"></a>
<FONT color="green">438</FONT>         */<a name="line.438"></a>
<FONT color="green">439</FONT>        public Preceding(int end) {<a name="line.439"></a>
<FONT color="green">440</FONT>          super(0, end);<a name="line.440"></a>
<FONT color="green">441</FONT>        }<a name="line.441"></a>
<FONT color="green">442</FONT>    <a name="line.442"></a>
<FONT color="green">443</FONT>        /**<a name="line.443"></a>
<FONT color="green">444</FONT>         * Constructs a context that will extract features over a slice of the preceding N annotations.<a name="line.444"></a>
<FONT color="green">445</FONT>         * <a name="line.445"></a>
<FONT color="green">446</FONT>         * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the<a name="line.446"></a>
<FONT color="green">447</FONT>         * annotation immediately preceding the focus annotation. If either index is greater than the<a name="line.447"></a>
<FONT color="green">448</FONT>         * index of the earliest possible annotation, special "out of bounds" features will be added for<a name="line.448"></a>
<FONT color="green">449</FONT>         * each annotation that was requested but absent.<a name="line.449"></a>
<FONT color="green">450</FONT>         * <a name="line.450"></a>
<FONT color="green">451</FONT>         * @param begin<a name="line.451"></a>
<FONT color="green">452</FONT>         *          The index of the first annotation to include.<a name="line.452"></a>
<FONT color="green">453</FONT>         * @param end<a name="line.453"></a>
<FONT color="green">454</FONT>         *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.454"></a>
<FONT color="green">455</FONT>         */<a name="line.455"></a>
<FONT color="green">456</FONT>        public Preceding(int begin, int end) {<a name="line.456"></a>
<FONT color="green">457</FONT>          super(begin, end);<a name="line.457"></a>
<FONT color="green">458</FONT>        }<a name="line.458"></a>
<FONT color="green">459</FONT>    <a name="line.459"></a>
<FONT color="green">460</FONT>        @Override<a name="line.460"></a>
<FONT color="green">461</FONT>        protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.461"></a>
<FONT color="green">462</FONT>            JCas jCas,<a name="line.462"></a>
<FONT color="green">463</FONT>            Annotation focusAnnotation,<a name="line.463"></a>
<FONT color="green">464</FONT>            Class&lt;T&gt; annotationClass,<a name="line.464"></a>
<FONT color="green">465</FONT>            int count) {<a name="line.465"></a>
<FONT color="green">466</FONT>          return JCasUtil.selectPreceding(jCas, annotationClass, focusAnnotation, count);<a name="line.466"></a>
<FONT color="green">467</FONT>        }<a name="line.467"></a>
<FONT color="green">468</FONT>      }<a name="line.468"></a>
<FONT color="green">469</FONT>    <a name="line.469"></a>
<FONT color="green">470</FONT>      /**<a name="line.470"></a>
<FONT color="green">471</FONT>       * A {@link Context} for extracting annotations appearing after the focus annotation.<a name="line.471"></a>
<FONT color="green">472</FONT>       */<a name="line.472"></a>
<FONT color="green">473</FONT>      public static class Following extends LeftToRightContext {<a name="line.473"></a>
<FONT color="green">474</FONT>    <a name="line.474"></a>
<FONT color="green">475</FONT>        /**<a name="line.475"></a>
<FONT color="green">476</FONT>         * Constructs a context that will extract features over the following N annotations.<a name="line.476"></a>
<FONT color="green">477</FONT>         * <a name="line.477"></a>
<FONT color="green">478</FONT>         * @param end<a name="line.478"></a>
<FONT color="green">479</FONT>         *          The number of annotations to extract.<a name="line.479"></a>
<FONT color="green">480</FONT>         */<a name="line.480"></a>
<FONT color="green">481</FONT>        public Following(int end) {<a name="line.481"></a>
<FONT color="green">482</FONT>          super(0, end);<a name="line.482"></a>
<FONT color="green">483</FONT>        }<a name="line.483"></a>
<FONT color="green">484</FONT>    <a name="line.484"></a>
<FONT color="green">485</FONT>        /**<a name="line.485"></a>
<FONT color="green">486</FONT>         * Constructs a context that will extract features over a slice of the following N annotations.<a name="line.486"></a>
<FONT color="green">487</FONT>         * <a name="line.487"></a>
<FONT color="green">488</FONT>         * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the<a name="line.488"></a>
<FONT color="green">489</FONT>         * annotation immediately following the focus annotation. If either index is greater than the<a name="line.489"></a>
<FONT color="green">490</FONT>         * index of the last possible annotation, special "out of bounds" features will be added for<a name="line.490"></a>
<FONT color="green">491</FONT>         * each annotation that was requested but absent.<a name="line.491"></a>
<FONT color="green">492</FONT>         * <a name="line.492"></a>
<FONT color="green">493</FONT>         * @param begin<a name="line.493"></a>
<FONT color="green">494</FONT>         *          The index of the first annotation to include.<a name="line.494"></a>
<FONT color="green">495</FONT>         * @param end<a name="line.495"></a>
<FONT color="green">496</FONT>         *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.496"></a>
<FONT color="green">497</FONT>         */<a name="line.497"></a>
<FONT color="green">498</FONT>        public Following(int begin, int end) {<a name="line.498"></a>
<FONT color="green">499</FONT>          super(begin, end);<a name="line.499"></a>
<FONT color="green">500</FONT>        }<a name="line.500"></a>
<FONT color="green">501</FONT>    <a name="line.501"></a>
<FONT color="green">502</FONT>        @Override<a name="line.502"></a>
<FONT color="green">503</FONT>        protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.503"></a>
<FONT color="green">504</FONT>            JCas jCas,<a name="line.504"></a>
<FONT color="green">505</FONT>            Annotation focusAnnotation,<a name="line.505"></a>
<FONT color="green">506</FONT>            Class&lt;T&gt; annotationClass,<a name="line.506"></a>
<FONT color="green">507</FONT>            int count) {<a name="line.507"></a>
<FONT color="green">508</FONT>          return JCasUtil.selectFollowing(jCas, annotationClass, focusAnnotation, count);<a name="line.508"></a>
<FONT color="green">509</FONT>        }<a name="line.509"></a>
<FONT color="green">510</FONT>      }<a name="line.510"></a>
<FONT color="green">511</FONT>    <a name="line.511"></a>
<FONT color="green">512</FONT>      /**<a name="line.512"></a>
<FONT color="green">513</FONT>       * A {@link Context} for extracting all annotations within the focus annotation.<a name="line.513"></a>
<FONT color="green">514</FONT>       */<a name="line.514"></a>
<FONT color="green">515</FONT>      public static class Covered implements Context {<a name="line.515"></a>
<FONT color="green">516</FONT>    <a name="line.516"></a>
<FONT color="green">517</FONT>        /**<a name="line.517"></a>
<FONT color="green">518</FONT>         * Constructs a context that will extract features over all annotations within the focus<a name="line.518"></a>
<FONT color="green">519</FONT>         * annotation.<a name="line.519"></a>
<FONT color="green">520</FONT>         */<a name="line.520"></a>
<FONT color="green">521</FONT>        public Covered() {<a name="line.521"></a>
<FONT color="green">522</FONT>        }<a name="line.522"></a>
<FONT color="green">523</FONT>    <a name="line.523"></a>
<FONT color="green">524</FONT>        @Override<a name="line.524"></a>
<FONT color="green">525</FONT>        public String getName() {<a name="line.525"></a>
<FONT color="green">526</FONT>          return "Covered";<a name="line.526"></a>
<FONT color="green">527</FONT>        }<a name="line.527"></a>
<FONT color="green">528</FONT>    <a name="line.528"></a>
<FONT color="green">529</FONT>        @Override<a name="line.529"></a>
<FONT color="green">530</FONT>        public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.530"></a>
<FONT color="green">531</FONT>            JCas jCas,<a name="line.531"></a>
<FONT color="green">532</FONT>            Annotation focusAnnotation,<a name="line.532"></a>
<FONT color="green">533</FONT>            Bounds bounds,<a name="line.533"></a>
<FONT color="green">534</FONT>            Class&lt;T&gt; annotationClass,<a name="line.534"></a>
<FONT color="green">535</FONT>            SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.535"></a>
<FONT color="green">536</FONT>          List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.536"></a>
<FONT color="green">537</FONT>          int pos = 0;<a name="line.537"></a>
<FONT color="green">538</FONT>          for (T ann : JCasUtil.selectCovered(jCas, annotationClass, focusAnnotation)) {<a name="line.538"></a>
<FONT color="green">539</FONT>            for (Feature feature : extractor.extract(jCas, ann)) {<a name="line.539"></a>
<FONT color="green">540</FONT>              features.add(new ContextFeature(this.getName(), pos, feature));<a name="line.540"></a>
<FONT color="green">541</FONT>            }<a name="line.541"></a>
<FONT color="green">542</FONT>            pos += 1;<a name="line.542"></a>
<FONT color="green">543</FONT>          }<a name="line.543"></a>
<FONT color="green">544</FONT>          return features;<a name="line.544"></a>
<FONT color="green">545</FONT>        }<a name="line.545"></a>
<FONT color="green">546</FONT>    <a name="line.546"></a>
<FONT color="green">547</FONT>      }<a name="line.547"></a>
<FONT color="green">548</FONT>    <a name="line.548"></a>
<FONT color="green">549</FONT>      /**<a name="line.549"></a>
<FONT color="green">550</FONT>       * A {@link Context} for extracting the first annotations within the focus annotation.<a name="line.550"></a>
<FONT color="green">551</FONT>       */<a name="line.551"></a>
<FONT color="green">552</FONT>      public static class FirstCovered extends LeftToRightContext {<a name="line.552"></a>
<FONT color="green">553</FONT>    <a name="line.553"></a>
<FONT color="green">554</FONT>        /**<a name="line.554"></a>
<FONT color="green">555</FONT>         * Constructs a context that will extract features over the first N annotations within the focus<a name="line.555"></a>
<FONT color="green">556</FONT>         * annotation.<a name="line.556"></a>
<FONT color="green">557</FONT>         * <a name="line.557"></a>
<FONT color="green">558</FONT>         * @param end<a name="line.558"></a>
<FONT color="green">559</FONT>         *          The number of annotations to extract.<a name="line.559"></a>
<FONT color="green">560</FONT>         */<a name="line.560"></a>
<FONT color="green">561</FONT>        public FirstCovered(int end) {<a name="line.561"></a>
<FONT color="green">562</FONT>          super(0, end);<a name="line.562"></a>
<FONT color="green">563</FONT>        }<a name="line.563"></a>
<FONT color="green">564</FONT>    <a name="line.564"></a>
<FONT color="green">565</FONT>        /**<a name="line.565"></a>
<FONT color="green">566</FONT>         * Constructs a context that will extract features over a slice of the first N annotations<a name="line.566"></a>
<FONT color="green">567</FONT>         * within the focus annotation.<a name="line.567"></a>
<FONT color="green">568</FONT>         * <a name="line.568"></a>
<FONT color="green">569</FONT>         * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the first<a name="line.569"></a>
<FONT color="green">570</FONT>         * annotation within the focus annotation. If either index is greater than the index of the last<a name="line.570"></a>
<FONT color="green">571</FONT>         * annotation within the focus annotation, special "out of bounds" features will be added for<a name="line.571"></a>
<FONT color="green">572</FONT>         * each annotation that was requested but absent.<a name="line.572"></a>
<FONT color="green">573</FONT>         * <a name="line.573"></a>
<FONT color="green">574</FONT>         * @param begin<a name="line.574"></a>
<FONT color="green">575</FONT>         *          The index of the first annotation to include.<a name="line.575"></a>
<FONT color="green">576</FONT>         * @param end<a name="line.576"></a>
<FONT color="green">577</FONT>         *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.577"></a>
<FONT color="green">578</FONT>         */<a name="line.578"></a>
<FONT color="green">579</FONT>        public FirstCovered(int begin, int end) {<a name="line.579"></a>
<FONT color="green">580</FONT>          super(begin, end);<a name="line.580"></a>
<FONT color="green">581</FONT>        }<a name="line.581"></a>
<FONT color="green">582</FONT>    <a name="line.582"></a>
<FONT color="green">583</FONT>        @Override<a name="line.583"></a>
<FONT color="green">584</FONT>        protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.584"></a>
<FONT color="green">585</FONT>            JCas jCas,<a name="line.585"></a>
<FONT color="green">586</FONT>            Annotation focusAnnotation,<a name="line.586"></a>
<FONT color="green">587</FONT>            Class&lt;T&gt; annotationClass,<a name="line.587"></a>
<FONT color="green">588</FONT>            int count) {<a name="line.588"></a>
<FONT color="green">589</FONT>          List&lt;T&gt; anns = JCasUtil.selectCovered(jCas, annotationClass, focusAnnotation);<a name="line.589"></a>
<FONT color="green">590</FONT>          return anns.subList(0, Math.min(count, anns.size()));<a name="line.590"></a>
<FONT color="green">591</FONT>        }<a name="line.591"></a>
<FONT color="green">592</FONT>      }<a name="line.592"></a>
<FONT color="green">593</FONT>    <a name="line.593"></a>
<FONT color="green">594</FONT>      /**<a name="line.594"></a>
<FONT color="green">595</FONT>       * A {@link Context} for extracting the last annotations within the focus annotation.<a name="line.595"></a>
<FONT color="green">596</FONT>       */<a name="line.596"></a>
<FONT color="green">597</FONT>      public static class LastCovered extends RightToLeftContext {<a name="line.597"></a>
<FONT color="green">598</FONT>    <a name="line.598"></a>
<FONT color="green">599</FONT>        /**<a name="line.599"></a>
<FONT color="green">600</FONT>         * Constructs a context that will extract features over the last N annotations within the focus<a name="line.600"></a>
<FONT color="green">601</FONT>         * annotation.<a name="line.601"></a>
<FONT color="green">602</FONT>         * <a name="line.602"></a>
<FONT color="green">603</FONT>         * @param end<a name="line.603"></a>
<FONT color="green">604</FONT>         *          The number of annotations to extract.<a name="line.604"></a>
<FONT color="green">605</FONT>         */<a name="line.605"></a>
<FONT color="green">606</FONT>        public LastCovered(int end) {<a name="line.606"></a>
<FONT color="green">607</FONT>          super(0, end);<a name="line.607"></a>
<FONT color="green">608</FONT>        }<a name="line.608"></a>
<FONT color="green">609</FONT>    <a name="line.609"></a>
<FONT color="green">610</FONT>        /**<a name="line.610"></a>
<FONT color="green">611</FONT>         * Constructs a context that will extract features over a slice of the last N annotations within<a name="line.611"></a>
<FONT color="green">612</FONT>         * the focus annotation.<a name="line.612"></a>
<FONT color="green">613</FONT>         * <a name="line.613"></a>
<FONT color="green">614</FONT>         * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the last<a name="line.614"></a>
<FONT color="green">615</FONT>         * annotation within the focus annotation. If either index is greater than the index of the<a name="line.615"></a>
<FONT color="green">616</FONT>         * first annotation within the focus annotation, special "out of bounds" features will be added<a name="line.616"></a>
<FONT color="green">617</FONT>         * for each annotation that was requested but absent.<a name="line.617"></a>
<FONT color="green">618</FONT>         * <a name="line.618"></a>
<FONT color="green">619</FONT>         * @param begin<a name="line.619"></a>
<FONT color="green">620</FONT>         *          The index of the first annotation to include.<a name="line.620"></a>
<FONT color="green">621</FONT>         * @param end<a name="line.621"></a>
<FONT color="green">622</FONT>         *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.622"></a>
<FONT color="green">623</FONT>         */<a name="line.623"></a>
<FONT color="green">624</FONT>        public LastCovered(int begin, int end) {<a name="line.624"></a>
<FONT color="green">625</FONT>          super(begin, end);<a name="line.625"></a>
<FONT color="green">626</FONT>        }<a name="line.626"></a>
<FONT color="green">627</FONT>    <a name="line.627"></a>
<FONT color="green">628</FONT>        @Override<a name="line.628"></a>
<FONT color="green">629</FONT>        protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.629"></a>
<FONT color="green">630</FONT>            JCas jCas,<a name="line.630"></a>
<FONT color="green">631</FONT>            Annotation focusAnnotation,<a name="line.631"></a>
<FONT color="green">632</FONT>            Class&lt;T&gt; annotationClass,<a name="line.632"></a>
<FONT color="green">633</FONT>            int count) {<a name="line.633"></a>
<FONT color="green">634</FONT>          List&lt;T&gt; anns = JCasUtil.selectCovered(jCas, annotationClass, focusAnnotation);<a name="line.634"></a>
<FONT color="green">635</FONT>          return anns.subList(Math.max(anns.size() - count, 0), anns.size());<a name="line.635"></a>
<FONT color="green">636</FONT>        }<a name="line.636"></a>
<FONT color="green">637</FONT>      }<a name="line.637"></a>
<FONT color="green">638</FONT>    <a name="line.638"></a>
<FONT color="green">639</FONT>      /**<a name="line.639"></a>
<FONT color="green">640</FONT>       * A {@link Context} that aggregates the features of other contexts into a "bag" where position<a name="line.640"></a>
<FONT color="green">641</FONT>       * information of each individual feature is no longer maintained. Position information is not<a name="line.641"></a>
<FONT color="green">642</FONT>       * entirely lost - the span of the bag is encoded as part of the feature name that is shared by<a name="line.642"></a>
<FONT color="green">643</FONT>       * all of the features within the bag.<a name="line.643"></a>
<FONT color="green">644</FONT>       */<a name="line.644"></a>
<FONT color="green">645</FONT>      public static class Bag implements Context {<a name="line.645"></a>
<FONT color="green">646</FONT>    <a name="line.646"></a>
<FONT color="green">647</FONT>        private Context[] contexts;<a name="line.647"></a>
<FONT color="green">648</FONT>    <a name="line.648"></a>
<FONT color="green">649</FONT>        private String name;<a name="line.649"></a>
<FONT color="green">650</FONT>    <a name="line.650"></a>
<FONT color="green">651</FONT>        /**<a name="line.651"></a>
<FONT color="green">652</FONT>         * Constructs a {@link Context} which converts the features extracted by the argument contexts<a name="line.652"></a>
<FONT color="green">653</FONT>         * into a bag of features where all features have the same name.<a name="line.653"></a>
<FONT color="green">654</FONT>         * <a name="line.654"></a>
<FONT color="green">655</FONT>         * @param contexts<a name="line.655"></a>
<FONT color="green">656</FONT>         *          The contexts which should be combined into a bag.<a name="line.656"></a>
<FONT color="green">657</FONT>         */<a name="line.657"></a>
<FONT color="green">658</FONT>        public Bag(Context... contexts) {<a name="line.658"></a>
<FONT color="green">659</FONT>          this.contexts = contexts;<a name="line.659"></a>
<FONT color="green">660</FONT>          String[] names = new String[contexts.length + 1];<a name="line.660"></a>
<FONT color="green">661</FONT>          names[0] = "Bag";<a name="line.661"></a>
<FONT color="green">662</FONT>          for (int i = 1; i &lt; names.length; ++i) {<a name="line.662"></a>
<FONT color="green">663</FONT>            names[i] = contexts[i - 1].getName();<a name="line.663"></a>
<FONT color="green">664</FONT>          }<a name="line.664"></a>
<FONT color="green">665</FONT>          this.name = Feature.createName(names);<a name="line.665"></a>
<FONT color="green">666</FONT>        }<a name="line.666"></a>
<FONT color="green">667</FONT>    <a name="line.667"></a>
<FONT color="green">668</FONT>        @Override<a name="line.668"></a>
<FONT color="green">669</FONT>        public String getName() {<a name="line.669"></a>
<FONT color="green">670</FONT>          return this.name;<a name="line.670"></a>
<FONT color="green">671</FONT>        }<a name="line.671"></a>
<FONT color="green">672</FONT>    <a name="line.672"></a>
<FONT color="green">673</FONT>        @Override<a name="line.673"></a>
<FONT color="green">674</FONT>        public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.674"></a>
<FONT color="green">675</FONT>            JCas jCas,<a name="line.675"></a>
<FONT color="green">676</FONT>            Annotation focusAnnotation,<a name="line.676"></a>
<FONT color="green">677</FONT>            Bounds bounds,<a name="line.677"></a>
<FONT color="green">678</FONT>            Class&lt;T&gt; annotationClass,<a name="line.678"></a>
<FONT color="green">679</FONT>            SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.679"></a>
<FONT color="green">680</FONT>          List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.680"></a>
<FONT color="green">681</FONT>          for (Context context : this.contexts) {<a name="line.681"></a>
<FONT color="green">682</FONT>            for (Feature feature : context.extract(<a name="line.682"></a>
<FONT color="green">683</FONT>                jCas,<a name="line.683"></a>
<FONT color="green">684</FONT>                focusAnnotation,<a name="line.684"></a>
<FONT color="green">685</FONT>                bounds,<a name="line.685"></a>
<FONT color="green">686</FONT>                annotationClass,<a name="line.686"></a>
<FONT color="green">687</FONT>                extractor)) {<a name="line.687"></a>
<FONT color="green">688</FONT>              ContextFeature contextFeature = (ContextFeature) feature;<a name="line.688"></a>
<FONT color="green">689</FONT>              String fName = Feature.createName(this.name, contextFeature.feature.getName());<a name="line.689"></a>
<FONT color="green">690</FONT>              features.add(new Feature(fName, feature.getValue()));<a name="line.690"></a>
<FONT color="green">691</FONT>            }<a name="line.691"></a>
<FONT color="green">692</FONT>          }<a name="line.692"></a>
<FONT color="green">693</FONT>          return features;<a name="line.693"></a>
<FONT color="green">694</FONT>        }<a name="line.694"></a>
<FONT color="green">695</FONT>      }<a name="line.695"></a>
<FONT color="green">696</FONT>    <a name="line.696"></a>
<FONT color="green">697</FONT>      /**<a name="line.697"></a>
<FONT color="green">698</FONT>       * A {@link Context} that aggregates the features of other contexts into a single "ngram" feature,<a name="line.698"></a>
<FONT color="green">699</FONT>       * where the feature values are concatenated together in order to form a single value.<a name="line.699"></a>
<FONT color="green">700</FONT>       */<a name="line.700"></a>
<FONT color="green">701</FONT>      public static class Ngram implements Context {<a name="line.701"></a>
<FONT color="green">702</FONT>        private Context[] contexts;<a name="line.702"></a>
<FONT color="green">703</FONT>    <a name="line.703"></a>
<FONT color="green">704</FONT>        private String name;<a name="line.704"></a>
<FONT color="green">705</FONT>    <a name="line.705"></a>
<FONT color="green">706</FONT>        /**<a name="line.706"></a>
<FONT color="green">707</FONT>         * Constructs a {@link Context} which converts the features extracted by the argument contexts<a name="line.707"></a>
<FONT color="green">708</FONT>         * into a single ngram feature where all feature values have been concatenated together.<a name="line.708"></a>
<FONT color="green">709</FONT>         * <a name="line.709"></a>
<FONT color="green">710</FONT>         * @param contexts<a name="line.710"></a>
<FONT color="green">711</FONT>         *          The contexts which should be combined into an ngram.<a name="line.711"></a>
<FONT color="green">712</FONT>         */<a name="line.712"></a>
<FONT color="green">713</FONT>        public Ngram(Context... contexts) {<a name="line.713"></a>
<FONT color="green">714</FONT>          this.contexts = contexts;<a name="line.714"></a>
<FONT color="green">715</FONT>          String[] names = new String[contexts.length + 1];<a name="line.715"></a>
<FONT color="green">716</FONT>          names[0] = "Ngram";<a name="line.716"></a>
<FONT color="green">717</FONT>          for (int i = 1; i &lt; names.length; ++i) {<a name="line.717"></a>
<FONT color="green">718</FONT>            names[i] = contexts[i - 1].getName();<a name="line.718"></a>
<FONT color="green">719</FONT>          }<a name="line.719"></a>
<FONT color="green">720</FONT>          this.name = Feature.createName(names);<a name="line.720"></a>
<FONT color="green">721</FONT>        }<a name="line.721"></a>
<FONT color="green">722</FONT>    <a name="line.722"></a>
<FONT color="green">723</FONT>        @Override<a name="line.723"></a>
<FONT color="green">724</FONT>        public String getName() {<a name="line.724"></a>
<FONT color="green">725</FONT>          return this.name;<a name="line.725"></a>
<FONT color="green">726</FONT>        }<a name="line.726"></a>
<FONT color="green">727</FONT>    <a name="line.727"></a>
<FONT color="green">728</FONT>        @Override<a name="line.728"></a>
<FONT color="green">729</FONT>        public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.729"></a>
<FONT color="green">730</FONT>            JCas jCas,<a name="line.730"></a>
<FONT color="green">731</FONT>            Annotation focusAnnotation,<a name="line.731"></a>
<FONT color="green">732</FONT>            Bounds bounds,<a name="line.732"></a>
<FONT color="green">733</FONT>            Class&lt;T&gt; annotationClass,<a name="line.733"></a>
<FONT color="green">734</FONT>            SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.734"></a>
<FONT color="green">735</FONT>          List&lt;String&gt; values = new ArrayList&lt;String&gt;();<a name="line.735"></a>
<FONT color="green">736</FONT>          for (Context context : this.contexts) {<a name="line.736"></a>
<FONT color="green">737</FONT>            for (Feature feature : context.extract(<a name="line.737"></a>
<FONT color="green">738</FONT>                jCas,<a name="line.738"></a>
<FONT color="green">739</FONT>                focusAnnotation,<a name="line.739"></a>
<FONT color="green">740</FONT>                bounds,<a name="line.740"></a>
<FONT color="green">741</FONT>                annotationClass,<a name="line.741"></a>
<FONT color="green">742</FONT>                extractor)) {<a name="line.742"></a>
<FONT color="green">743</FONT>              values.add(String.valueOf(feature.getValue()));<a name="line.743"></a>
<FONT color="green">744</FONT>            }<a name="line.744"></a>
<FONT color="green">745</FONT>          }<a name="line.745"></a>
<FONT color="green">746</FONT>          return Arrays.asList(new Feature(this.name, StringUtils.join(values, '_')));<a name="line.746"></a>
<FONT color="green">747</FONT>        }<a name="line.747"></a>
<FONT color="green">748</FONT>      }<a name="line.748"></a>
<FONT color="green">749</FONT>    }<a name="line.749"></a>




























































</PRE>
</BODY>
</HTML>
