<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>/*<a name="line.1"></a>
<span class="sourceLineNo">002</span> * Copyright (c) 2011, Regents of the University of Colorado <a name="line.2"></a>
<span class="sourceLineNo">003</span> * All rights reserved.<a name="line.3"></a>
<span class="sourceLineNo">004</span> * <a name="line.4"></a>
<span class="sourceLineNo">005</span> * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<span class="sourceLineNo">006</span> * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<span class="sourceLineNo">007</span> * <a name="line.7"></a>
<span class="sourceLineNo">008</span> * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<span class="sourceLineNo">009</span> * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<span class="sourceLineNo">010</span> * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<span class="sourceLineNo">011</span> * <a name="line.11"></a>
<span class="sourceLineNo">012</span> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<span class="sourceLineNo">013</span> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<span class="sourceLineNo">014</span> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<span class="sourceLineNo">015</span> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<span class="sourceLineNo">016</span> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<span class="sourceLineNo">017</span> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<span class="sourceLineNo">018</span> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<span class="sourceLineNo">019</span> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<span class="sourceLineNo">020</span> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<span class="sourceLineNo">021</span> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<span class="sourceLineNo">022</span> * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<span class="sourceLineNo">023</span> */<a name="line.23"></a>
<span class="sourceLineNo">024</span>package org.cleartk.classifier.feature.extractor;<a name="line.24"></a>
<span class="sourceLineNo">025</span><a name="line.25"></a>
<span class="sourceLineNo">026</span>import java.util.ArrayList;<a name="line.26"></a>
<span class="sourceLineNo">027</span>import java.util.Arrays;<a name="line.27"></a>
<span class="sourceLineNo">028</span>import java.util.Iterator;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import java.util.List;<a name="line.29"></a>
<span class="sourceLineNo">030</span><a name="line.30"></a>
<span class="sourceLineNo">031</span>import org.apache.commons.lang.StringUtils;<a name="line.31"></a>
<span class="sourceLineNo">032</span>import org.apache.uima.jcas.JCas;<a name="line.32"></a>
<span class="sourceLineNo">033</span>import org.apache.uima.jcas.tcas.Annotation;<a name="line.33"></a>
<span class="sourceLineNo">034</span>import org.cleartk.classifier.Feature;<a name="line.34"></a>
<span class="sourceLineNo">035</span>import org.cleartk.classifier.feature.extractor.simple.SimpleFeatureExtractor;<a name="line.35"></a>
<span class="sourceLineNo">036</span>import org.uimafit.util.JCasUtil;<a name="line.36"></a>
<span class="sourceLineNo">037</span><a name="line.37"></a>
<span class="sourceLineNo">038</span>import com.google.common.base.Joiner;<a name="line.38"></a>
<span class="sourceLineNo">039</span>import com.google.common.collect.LinkedHashMultiset;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import com.google.common.collect.Multiset;<a name="line.40"></a>
<span class="sourceLineNo">041</span><a name="line.41"></a>
<span class="sourceLineNo">042</span>/**<a name="line.42"></a>
<span class="sourceLineNo">043</span> * A feature extractor that finds other {@link Annotation}s in the context of a focus annotation and<a name="line.43"></a>
<span class="sourceLineNo">044</span> * extracts features from these. It can be used, for example, to:<a name="line.44"></a>
<span class="sourceLineNo">045</span> * &lt;ul&gt;<a name="line.45"></a>
<span class="sourceLineNo">046</span> * &lt;li&gt;Get the text of the 2 tokens before a focus annotation&lt;/li&gt;<a name="line.46"></a>
<span class="sourceLineNo">047</span> * &lt;li&gt;Get the parts of speech of the 3 tokens after a focus annotation&lt;/li&gt;<a name="line.47"></a>
<span class="sourceLineNo">048</span> * &lt;li&gt;Get the tokens after a focus annotation, beginning 2 after and ending 5 after, as a bag of<a name="line.48"></a>
<span class="sourceLineNo">049</span> * words&lt;/li&gt;<a name="line.49"></a>
<span class="sourceLineNo">050</span> * &lt;li&gt;Get an ngram concatenating the stem of the first word before a focus annotation and the first<a name="line.50"></a>
<span class="sourceLineNo">051</span> * word contained in the focus annotation&lt;/li&gt;<a name="line.51"></a>
<span class="sourceLineNo">052</span> * &lt;li&gt;&lt;/li&gt;<a name="line.52"></a>
<span class="sourceLineNo">053</span> * &lt;/ul&gt;<a name="line.53"></a>
<span class="sourceLineNo">054</span> * <a name="line.54"></a>
<span class="sourceLineNo">055</span> * &lt;br&gt;<a name="line.55"></a>
<span class="sourceLineNo">056</span> * Copyright (c) 2011, Regents of the University of Colorado &lt;br&gt;<a name="line.56"></a>
<span class="sourceLineNo">057</span> * All rights reserved.<a name="line.57"></a>
<span class="sourceLineNo">058</span> * <a name="line.58"></a>
<span class="sourceLineNo">059</span> * @author Steven Bethard<a name="line.59"></a>
<span class="sourceLineNo">060</span> */<a name="line.60"></a>
<span class="sourceLineNo">061</span>public class CleartkExtractor implements SimpleFeatureExtractor, BetweenAnnotationsFeatureExtractor {<a name="line.61"></a>
<span class="sourceLineNo">062</span><a name="line.62"></a>
<span class="sourceLineNo">063</span>  private Class&lt;? extends Annotation&gt; annotationClass;<a name="line.63"></a>
<span class="sourceLineNo">064</span><a name="line.64"></a>
<span class="sourceLineNo">065</span>  private SimpleFeatureExtractor extractor;<a name="line.65"></a>
<span class="sourceLineNo">066</span><a name="line.66"></a>
<span class="sourceLineNo">067</span>  private Context[] contexts;<a name="line.67"></a>
<span class="sourceLineNo">068</span><a name="line.68"></a>
<span class="sourceLineNo">069</span>  /**<a name="line.69"></a>
<span class="sourceLineNo">070</span>   * Create an extractor that finds {@link Annotation}s of the given type at the specified<a name="line.70"></a>
<span class="sourceLineNo">071</span>   * {@link Context}s and applies the given feature extractor to the annotations.<a name="line.71"></a>
<span class="sourceLineNo">072</span>   * <a name="line.72"></a>
<span class="sourceLineNo">073</span>   * @param annotationClass<a name="line.73"></a>
<span class="sourceLineNo">074</span>   *          The type of annotation which should be searched for in the context.<a name="line.74"></a>
<span class="sourceLineNo">075</span>   * @param extractor<a name="line.75"></a>
<span class="sourceLineNo">076</span>   *          The feature extractor to apply to each annotation found.<a name="line.76"></a>
<span class="sourceLineNo">077</span>   * @param contexts<a name="line.77"></a>
<span class="sourceLineNo">078</span>   *          The contexts where the extractor should look for annotations.<a name="line.78"></a>
<span class="sourceLineNo">079</span>   */<a name="line.79"></a>
<span class="sourceLineNo">080</span>  public CleartkExtractor(<a name="line.80"></a>
<span class="sourceLineNo">081</span>      Class&lt;? extends Annotation&gt; annotationClass,<a name="line.81"></a>
<span class="sourceLineNo">082</span>      SimpleFeatureExtractor extractor,<a name="line.82"></a>
<span class="sourceLineNo">083</span>      Context... contexts) {<a name="line.83"></a>
<span class="sourceLineNo">084</span>    this.annotationClass = annotationClass;<a name="line.84"></a>
<span class="sourceLineNo">085</span>    this.extractor = extractor;<a name="line.85"></a>
<span class="sourceLineNo">086</span>    this.contexts = contexts;<a name="line.86"></a>
<span class="sourceLineNo">087</span>  }<a name="line.87"></a>
<span class="sourceLineNo">088</span><a name="line.88"></a>
<span class="sourceLineNo">089</span>  @Override<a name="line.89"></a>
<span class="sourceLineNo">090</span>  public List&lt;Feature&gt; extract(JCas view, Annotation focusAnnotation)<a name="line.90"></a>
<span class="sourceLineNo">091</span>      throws CleartkExtractorException {<a name="line.91"></a>
<span class="sourceLineNo">092</span>    return this.extract(view, focusAnnotation, new NoBounds());<a name="line.92"></a>
<span class="sourceLineNo">093</span>  }<a name="line.93"></a>
<span class="sourceLineNo">094</span><a name="line.94"></a>
<span class="sourceLineNo">095</span>  /**<a name="line.95"></a>
<span class="sourceLineNo">096</span>   * Extract features from the annotations around the focus annotation and within the given bounds.<a name="line.96"></a>
<span class="sourceLineNo">097</span>   * <a name="line.97"></a>
<span class="sourceLineNo">098</span>   * @param view<a name="line.98"></a>
<span class="sourceLineNo">099</span>   *          The JCas containing the focus annotation.<a name="line.99"></a>
<span class="sourceLineNo">100</span>   * @param focusAnnotation<a name="line.100"></a>
<span class="sourceLineNo">101</span>   *          The annotation whose context is to be searched.<a name="line.101"></a>
<span class="sourceLineNo">102</span>   * @param boundsAnnotation<a name="line.102"></a>
<span class="sourceLineNo">103</span>   *          The boundary within which context annotations may be identified.<a name="line.103"></a>
<span class="sourceLineNo">104</span>   * @return The features extracted in the context of the focus annotation.<a name="line.104"></a>
<span class="sourceLineNo">105</span>   */<a name="line.105"></a>
<span class="sourceLineNo">106</span>  public List&lt;Feature&gt; extractWithin(<a name="line.106"></a>
<span class="sourceLineNo">107</span>      JCas view,<a name="line.107"></a>
<span class="sourceLineNo">108</span>      Annotation focusAnnotation,<a name="line.108"></a>
<span class="sourceLineNo">109</span>      Annotation boundsAnnotation) throws CleartkExtractorException {<a name="line.109"></a>
<span class="sourceLineNo">110</span>    Bounds bounds = new SpanBounds(boundsAnnotation.getBegin(), boundsAnnotation.getEnd());<a name="line.110"></a>
<span class="sourceLineNo">111</span>    return this.extract(view, focusAnnotation, bounds);<a name="line.111"></a>
<span class="sourceLineNo">112</span>  }<a name="line.112"></a>
<span class="sourceLineNo">113</span><a name="line.113"></a>
<span class="sourceLineNo">114</span>  @Override<a name="line.114"></a>
<span class="sourceLineNo">115</span>  public List&lt;Feature&gt; extractBetween(JCas view, Annotation annotation1, Annotation annotation2)<a name="line.115"></a>
<span class="sourceLineNo">116</span>      throws CleartkExtractorException {<a name="line.116"></a>
<span class="sourceLineNo">117</span>    int begin = annotation1.getEnd();<a name="line.117"></a>
<span class="sourceLineNo">118</span>    int end = annotation2.getBegin();<a name="line.118"></a>
<span class="sourceLineNo">119</span>    // FIXME: creating a new annotation may leak memory - is there a better approach?<a name="line.119"></a>
<span class="sourceLineNo">120</span>    Annotation focusAnnotation = new Annotation(view, begin, end);<a name="line.120"></a>
<span class="sourceLineNo">121</span>    return this.extract(view, focusAnnotation, new NoBounds());<a name="line.121"></a>
<span class="sourceLineNo">122</span>  }<a name="line.122"></a>
<span class="sourceLineNo">123</span><a name="line.123"></a>
<span class="sourceLineNo">124</span>  private List&lt;Feature&gt; extract(JCas view, Annotation focusAnnotation, Bounds bounds)<a name="line.124"></a>
<span class="sourceLineNo">125</span>      throws CleartkExtractorException {<a name="line.125"></a>
<span class="sourceLineNo">126</span>    List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.126"></a>
<span class="sourceLineNo">127</span>    for (Context context : this.contexts) {<a name="line.127"></a>
<span class="sourceLineNo">128</span>      features.addAll(context.extract(<a name="line.128"></a>
<span class="sourceLineNo">129</span>          view,<a name="line.129"></a>
<span class="sourceLineNo">130</span>          focusAnnotation,<a name="line.130"></a>
<span class="sourceLineNo">131</span>          bounds,<a name="line.131"></a>
<span class="sourceLineNo">132</span>          this.annotationClass,<a name="line.132"></a>
<span class="sourceLineNo">133</span>          this.extractor));<a name="line.133"></a>
<span class="sourceLineNo">134</span>    }<a name="line.134"></a>
<span class="sourceLineNo">135</span>    return features;<a name="line.135"></a>
<span class="sourceLineNo">136</span>  }<a name="line.136"></a>
<span class="sourceLineNo">137</span><a name="line.137"></a>
<span class="sourceLineNo">138</span>  /**<a name="line.138"></a>
<span class="sourceLineNo">139</span>   * A class representing the bounds within which a {@link CleartkExtractor} should look for<a name="line.139"></a>
<span class="sourceLineNo">140</span>   * annotations.<a name="line.140"></a>
<span class="sourceLineNo">141</span>   */<a name="line.141"></a>
<span class="sourceLineNo">142</span>  public static interface Bounds {<a name="line.142"></a>
<span class="sourceLineNo">143</span><a name="line.143"></a>
<span class="sourceLineNo">144</span>    /**<a name="line.144"></a>
<span class="sourceLineNo">145</span>     * Determines whether or not an annotation lies within the given bounds.<a name="line.145"></a>
<span class="sourceLineNo">146</span>     * <a name="line.146"></a>
<span class="sourceLineNo">147</span>     * @param annotation<a name="line.147"></a>
<span class="sourceLineNo">148</span>     *          The annotation to be checked.<a name="line.148"></a>
<span class="sourceLineNo">149</span>     * @return True if the annotation lies within the bounds.<a name="line.149"></a>
<span class="sourceLineNo">150</span>     */<a name="line.150"></a>
<span class="sourceLineNo">151</span>    public boolean contains(Annotation annotation);<a name="line.151"></a>
<span class="sourceLineNo">152</span>  }<a name="line.152"></a>
<span class="sourceLineNo">153</span><a name="line.153"></a>
<span class="sourceLineNo">154</span>  /**<a name="line.154"></a>
<span class="sourceLineNo">155</span>   * A Bounds implementation that puts no restrictions on the context.<a name="line.155"></a>
<span class="sourceLineNo">156</span>   */<a name="line.156"></a>
<span class="sourceLineNo">157</span>  private static class NoBounds implements Bounds {<a name="line.157"></a>
<span class="sourceLineNo">158</span><a name="line.158"></a>
<span class="sourceLineNo">159</span>    public NoBounds() {<a name="line.159"></a>
<span class="sourceLineNo">160</span>    }<a name="line.160"></a>
<span class="sourceLineNo">161</span><a name="line.161"></a>
<span class="sourceLineNo">162</span>    @Override<a name="line.162"></a>
<span class="sourceLineNo">163</span>    public boolean contains(Annotation annotation) {<a name="line.163"></a>
<span class="sourceLineNo">164</span>      return true;<a name="line.164"></a>
<span class="sourceLineNo">165</span>    }<a name="line.165"></a>
<span class="sourceLineNo">166</span><a name="line.166"></a>
<span class="sourceLineNo">167</span>  }<a name="line.167"></a>
<span class="sourceLineNo">168</span><a name="line.168"></a>
<span class="sourceLineNo">169</span>  /**<a name="line.169"></a>
<span class="sourceLineNo">170</span>   * A Bounds implementation that restricts the context to annotations within a given span.<a name="line.170"></a>
<span class="sourceLineNo">171</span>   */<a name="line.171"></a>
<span class="sourceLineNo">172</span>  private static class SpanBounds implements Bounds {<a name="line.172"></a>
<span class="sourceLineNo">173</span><a name="line.173"></a>
<span class="sourceLineNo">174</span>    private int begin;<a name="line.174"></a>
<span class="sourceLineNo">175</span><a name="line.175"></a>
<span class="sourceLineNo">176</span>    private int end;<a name="line.176"></a>
<span class="sourceLineNo">177</span><a name="line.177"></a>
<span class="sourceLineNo">178</span>    public SpanBounds(int begin, int end) {<a name="line.178"></a>
<span class="sourceLineNo">179</span>      this.begin = begin;<a name="line.179"></a>
<span class="sourceLineNo">180</span>      this.end = end;<a name="line.180"></a>
<span class="sourceLineNo">181</span>    }<a name="line.181"></a>
<span class="sourceLineNo">182</span><a name="line.182"></a>
<span class="sourceLineNo">183</span>    @Override<a name="line.183"></a>
<span class="sourceLineNo">184</span>    public boolean contains(Annotation annotation) {<a name="line.184"></a>
<span class="sourceLineNo">185</span>      return annotation.getBegin() &gt;= this.begin &amp;&amp; annotation.getEnd() &lt;= this.end;<a name="line.185"></a>
<span class="sourceLineNo">186</span>    }<a name="line.186"></a>
<span class="sourceLineNo">187</span><a name="line.187"></a>
<span class="sourceLineNo">188</span>  }<a name="line.188"></a>
<span class="sourceLineNo">189</span><a name="line.189"></a>
<span class="sourceLineNo">190</span>  /**<a name="line.190"></a>
<span class="sourceLineNo">191</span>   * A class representing a location that a {@link CleartkExtractor} should look for annotations.<a name="line.191"></a>
<span class="sourceLineNo">192</span>   */<a name="line.192"></a>
<span class="sourceLineNo">193</span>  public static interface Context {<a name="line.193"></a>
<span class="sourceLineNo">194</span><a name="line.194"></a>
<span class="sourceLineNo">195</span>    /**<a name="line.195"></a>
<span class="sourceLineNo">196</span>     * Gets the base feature name that will be used in {@link Feature}s generated by this context.<a name="line.196"></a>
<span class="sourceLineNo">197</span>     * The actual feature names may include additional information (e.g. relative position), but<a name="line.197"></a>
<span class="sourceLineNo">198</span>     * this base name should be used in all aggregating contexts like {@link Bag} or {@link Ngram}.<a name="line.198"></a>
<span class="sourceLineNo">199</span>     * <a name="line.199"></a>
<span class="sourceLineNo">200</span>     * @return The base feature name.<a name="line.200"></a>
<span class="sourceLineNo">201</span>     */<a name="line.201"></a>
<span class="sourceLineNo">202</span>    public String getName();<a name="line.202"></a>
<span class="sourceLineNo">203</span><a name="line.203"></a>
<span class="sourceLineNo">204</span>    /**<a name="line.204"></a>
<span class="sourceLineNo">205</span>     * Extracts features in the given context.<a name="line.205"></a>
<span class="sourceLineNo">206</span>     * <a name="line.206"></a>
<span class="sourceLineNo">207</span>     * @param jCas<a name="line.207"></a>
<span class="sourceLineNo">208</span>     *          The {@link JCas} containing the focus annotation.<a name="line.208"></a>
<span class="sourceLineNo">209</span>     * @param focusAnnotation<a name="line.209"></a>
<span class="sourceLineNo">210</span>     *          The annotation whose context is to be searched.<a name="line.210"></a>
<span class="sourceLineNo">211</span>     * @param annotationClass<a name="line.211"></a>
<span class="sourceLineNo">212</span>     *          The type of annotation to be found in the context.<a name="line.212"></a>
<span class="sourceLineNo">213</span>     * @param extractor<a name="line.213"></a>
<span class="sourceLineNo">214</span>     *          The feature extractor that should be applied to each annotation found in the<a name="line.214"></a>
<span class="sourceLineNo">215</span>     *          context.<a name="line.215"></a>
<span class="sourceLineNo">216</span>     * @return The list of features extracted.<a name="line.216"></a>
<span class="sourceLineNo">217</span>     */<a name="line.217"></a>
<span class="sourceLineNo">218</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.218"></a>
<span class="sourceLineNo">219</span>        JCas jCas,<a name="line.219"></a>
<span class="sourceLineNo">220</span>        Annotation focusAnnotation,<a name="line.220"></a>
<span class="sourceLineNo">221</span>        Bounds bounds,<a name="line.221"></a>
<span class="sourceLineNo">222</span>        Class&lt;T&gt; annotationClass,<a name="line.222"></a>
<span class="sourceLineNo">223</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException;<a name="line.223"></a>
<span class="sourceLineNo">224</span>  }<a name="line.224"></a>
<span class="sourceLineNo">225</span><a name="line.225"></a>
<span class="sourceLineNo">226</span>  /**<a name="line.226"></a>
<span class="sourceLineNo">227</span>   * A subclass of {@link Feature} that the base feature extractors wrap their features in. This<a name="line.227"></a>
<span class="sourceLineNo">228</span>   * enables aggregating contexts like {@link Bag} or {@link Ngram} to name their features properly.<a name="line.228"></a>
<span class="sourceLineNo">229</span>   */<a name="line.229"></a>
<span class="sourceLineNo">230</span>  private static class ContextFeature extends Feature {<a name="line.230"></a>
<span class="sourceLineNo">231</span>    private static final long serialVersionUID = 1L;<a name="line.231"></a>
<span class="sourceLineNo">232</span><a name="line.232"></a>
<span class="sourceLineNo">233</span>    public Feature feature;<a name="line.233"></a>
<span class="sourceLineNo">234</span><a name="line.234"></a>
<span class="sourceLineNo">235</span>    public ContextFeature(String baseName, Feature feature) {<a name="line.235"></a>
<span class="sourceLineNo">236</span>      this.feature = feature;<a name="line.236"></a>
<span class="sourceLineNo">237</span>      this.setName(Feature.createName(baseName, feature.getName()));<a name="line.237"></a>
<span class="sourceLineNo">238</span>      this.setValue(this.feature.getValue());<a name="line.238"></a>
<span class="sourceLineNo">239</span>    }<a name="line.239"></a>
<span class="sourceLineNo">240</span><a name="line.240"></a>
<span class="sourceLineNo">241</span>    public ContextFeature(String baseName, int position, Feature feature) {<a name="line.241"></a>
<span class="sourceLineNo">242</span>      this.feature = feature;<a name="line.242"></a>
<span class="sourceLineNo">243</span>      this.setName(Feature.createName(baseName, String.valueOf(position), feature.getName()));<a name="line.243"></a>
<span class="sourceLineNo">244</span>      this.setValue(feature.getValue());<a name="line.244"></a>
<span class="sourceLineNo">245</span>    }<a name="line.245"></a>
<span class="sourceLineNo">246</span><a name="line.246"></a>
<span class="sourceLineNo">247</span>    public ContextFeature(String baseName, int position, int oobPosition) {<a name="line.247"></a>
<span class="sourceLineNo">248</span>      this.feature = new Feature(null, String.format("OOB%d", oobPosition));<a name="line.248"></a>
<span class="sourceLineNo">249</span>      this.setName(Feature.createName(baseName, String.valueOf(position)));<a name="line.249"></a>
<span class="sourceLineNo">250</span>      this.setValue(this.feature.getValue());<a name="line.250"></a>
<span class="sourceLineNo">251</span>    }<a name="line.251"></a>
<span class="sourceLineNo">252</span>  }<a name="line.252"></a>
<span class="sourceLineNo">253</span><a name="line.253"></a>
<span class="sourceLineNo">254</span>  /**<a name="line.254"></a>
<span class="sourceLineNo">255</span>   * Base class for simple contexts that have a single begin and end.<a name="line.255"></a>
<span class="sourceLineNo">256</span>   */<a name="line.256"></a>
<span class="sourceLineNo">257</span>  private static abstract class Context_ImplBase implements Context {<a name="line.257"></a>
<span class="sourceLineNo">258</span>    protected int begin;<a name="line.258"></a>
<span class="sourceLineNo">259</span><a name="line.259"></a>
<span class="sourceLineNo">260</span>    protected int end;<a name="line.260"></a>
<span class="sourceLineNo">261</span><a name="line.261"></a>
<span class="sourceLineNo">262</span>    private String name;<a name="line.262"></a>
<span class="sourceLineNo">263</span><a name="line.263"></a>
<span class="sourceLineNo">264</span>    public Context_ImplBase(int begin, int end) {<a name="line.264"></a>
<span class="sourceLineNo">265</span>      if (begin &gt; end) {<a name="line.265"></a>
<span class="sourceLineNo">266</span>        String message = "expected begin &lt; end, found begin=%d end=%d";<a name="line.266"></a>
<span class="sourceLineNo">267</span>        throw new IllegalArgumentException(String.format(message, begin, end));<a name="line.267"></a>
<span class="sourceLineNo">268</span>      }<a name="line.268"></a>
<span class="sourceLineNo">269</span>      this.begin = begin;<a name="line.269"></a>
<span class="sourceLineNo">270</span>      this.end = end;<a name="line.270"></a>
<span class="sourceLineNo">271</span>      this.name = Feature.createName(<a name="line.271"></a>
<span class="sourceLineNo">272</span>          this.getClass().getSimpleName(),<a name="line.272"></a>
<span class="sourceLineNo">273</span>          String.valueOf(this.begin),<a name="line.273"></a>
<span class="sourceLineNo">274</span>          String.valueOf(this.end));<a name="line.274"></a>
<span class="sourceLineNo">275</span>    }<a name="line.275"></a>
<span class="sourceLineNo">276</span><a name="line.276"></a>
<span class="sourceLineNo">277</span>    @Override<a name="line.277"></a>
<span class="sourceLineNo">278</span>    public String getName() {<a name="line.278"></a>
<span class="sourceLineNo">279</span>      return this.name;<a name="line.279"></a>
<span class="sourceLineNo">280</span>    }<a name="line.280"></a>
<span class="sourceLineNo">281</span><a name="line.281"></a>
<span class="sourceLineNo">282</span>    /**<a name="line.282"></a>
<span class="sourceLineNo">283</span>     * Select annotations of the given type in the context of the focus annotation. The returned<a name="line.283"></a>
<span class="sourceLineNo">284</span>     * annotations should be in order (smaller begin/end offsets before larger begin/end offsets).<a name="line.284"></a>
<span class="sourceLineNo">285</span>     * <a name="line.285"></a>
<span class="sourceLineNo">286</span>     * @param jCas<a name="line.286"></a>
<span class="sourceLineNo">287</span>     *          The {@link JCas} containing the focus annotation.<a name="line.287"></a>
<span class="sourceLineNo">288</span>     * @param focusAnnotation<a name="line.288"></a>
<span class="sourceLineNo">289</span>     *          The annotation whose context is to be searched.<a name="line.289"></a>
<span class="sourceLineNo">290</span>     * @param annotationClass<a name="line.290"></a>
<span class="sourceLineNo">291</span>     *          The type of annotation to be found in the context.<a name="line.291"></a>
<span class="sourceLineNo">292</span>     * @param count<a name="line.292"></a>
<span class="sourceLineNo">293</span>     *          The number of annotations to select. A smaller number may be returned if it is not<a name="line.293"></a>
<span class="sourceLineNo">294</span>     *          possible to select the requested number.<a name="line.294"></a>
<span class="sourceLineNo">295</span>     * @return The annotations in the context of the focus annotation.<a name="line.295"></a>
<span class="sourceLineNo">296</span>     */<a name="line.296"></a>
<span class="sourceLineNo">297</span>    protected abstract &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.297"></a>
<span class="sourceLineNo">298</span>        JCas jCas,<a name="line.298"></a>
<span class="sourceLineNo">299</span>        Annotation focusAnnotation,<a name="line.299"></a>
<span class="sourceLineNo">300</span>        Class&lt;T&gt; annotationClass,<a name="line.300"></a>
<span class="sourceLineNo">301</span>        int count);<a name="line.301"></a>
<span class="sourceLineNo">302</span>  }<a name="line.302"></a>
<span class="sourceLineNo">303</span><a name="line.303"></a>
<span class="sourceLineNo">304</span>  /**<a name="line.304"></a>
<span class="sourceLineNo">305</span>   * Base class for simple contexts that scan their annotations from right to left.<a name="line.305"></a>
<span class="sourceLineNo">306</span>   */<a name="line.306"></a>
<span class="sourceLineNo">307</span>  private static abstract class RightToLeftContext extends Context_ImplBase {<a name="line.307"></a>
<span class="sourceLineNo">308</span><a name="line.308"></a>
<span class="sourceLineNo">309</span>    public RightToLeftContext(int begin, int end) {<a name="line.309"></a>
<span class="sourceLineNo">310</span>      super(begin, end);<a name="line.310"></a>
<span class="sourceLineNo">311</span>    }<a name="line.311"></a>
<span class="sourceLineNo">312</span><a name="line.312"></a>
<span class="sourceLineNo">313</span>    @Override<a name="line.313"></a>
<span class="sourceLineNo">314</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.314"></a>
<span class="sourceLineNo">315</span>        JCas jCas,<a name="line.315"></a>
<span class="sourceLineNo">316</span>        Annotation focusAnnotation,<a name="line.316"></a>
<span class="sourceLineNo">317</span>        Bounds bounds,<a name="line.317"></a>
<span class="sourceLineNo">318</span>        Class&lt;T&gt; annotationClass,<a name="line.318"></a>
<span class="sourceLineNo">319</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.319"></a>
<span class="sourceLineNo">320</span><a name="line.320"></a>
<span class="sourceLineNo">321</span>      // slice the appropriate annotations from the CAS<a name="line.321"></a>
<span class="sourceLineNo">322</span>      List&lt;T&gt; anns = this.select(jCas, focusAnnotation, annotationClass, this.end);<a name="line.322"></a>
<span class="sourceLineNo">323</span>      anns = anns.subList(0, anns.size() - this.begin);<a name="line.323"></a>
<span class="sourceLineNo">324</span>      int missing = this.end - this.begin - anns.size();<a name="line.324"></a>
<span class="sourceLineNo">325</span><a name="line.325"></a>
<span class="sourceLineNo">326</span>      // figure out how many items are out of bounds<a name="line.326"></a>
<span class="sourceLineNo">327</span>      int oobPos = missing;<a name="line.327"></a>
<span class="sourceLineNo">328</span>      for (T ann : anns) {<a name="line.328"></a>
<span class="sourceLineNo">329</span>        if (!bounds.contains(ann)) {<a name="line.329"></a>
<span class="sourceLineNo">330</span>          oobPos += 1;<a name="line.330"></a>
<span class="sourceLineNo">331</span>        }<a name="line.331"></a>
<span class="sourceLineNo">332</span>      }<a name="line.332"></a>
<span class="sourceLineNo">333</span><a name="line.333"></a>
<span class="sourceLineNo">334</span>      // extract features at each position<a name="line.334"></a>
<span class="sourceLineNo">335</span>      List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.335"></a>
<span class="sourceLineNo">336</span>      for (int pos = this.end - 1; pos &gt;= this.begin; pos -= 1) {<a name="line.336"></a>
<span class="sourceLineNo">337</span><a name="line.337"></a>
<span class="sourceLineNo">338</span>        // if the annotation at the current position is in bounds, extract features from it<a name="line.338"></a>
<span class="sourceLineNo">339</span>        int adjustedPos = this.end - 1 - pos - missing;<a name="line.339"></a>
<span class="sourceLineNo">340</span>        T ann = adjustedPos &gt;= 0 ? anns.get(adjustedPos) : null;<a name="line.340"></a>
<span class="sourceLineNo">341</span>        if (ann != null &amp;&amp; bounds.contains(ann)) {<a name="line.341"></a>
<span class="sourceLineNo">342</span>          for (Feature feature : extractor.extract(jCas, ann)) {<a name="line.342"></a>
<span class="sourceLineNo">343</span>            features.add(new ContextFeature(this.getName(), pos, feature));<a name="line.343"></a>
<span class="sourceLineNo">344</span>          }<a name="line.344"></a>
<span class="sourceLineNo">345</span>        }<a name="line.345"></a>
<span class="sourceLineNo">346</span><a name="line.346"></a>
<span class="sourceLineNo">347</span>        // if the annotation at the current position is out of bounds, add an out-of-bounds feature<a name="line.347"></a>
<span class="sourceLineNo">348</span>        else {<a name="line.348"></a>
<span class="sourceLineNo">349</span>          features.add(new ContextFeature(this.getName(), pos, oobPos));<a name="line.349"></a>
<span class="sourceLineNo">350</span>          oobPos -= 1;<a name="line.350"></a>
<span class="sourceLineNo">351</span>        }<a name="line.351"></a>
<span class="sourceLineNo">352</span>      }<a name="line.352"></a>
<span class="sourceLineNo">353</span>      return features;<a name="line.353"></a>
<span class="sourceLineNo">354</span>    }<a name="line.354"></a>
<span class="sourceLineNo">355</span>  }<a name="line.355"></a>
<span class="sourceLineNo">356</span><a name="line.356"></a>
<span class="sourceLineNo">357</span>  /**<a name="line.357"></a>
<span class="sourceLineNo">358</span>   * Base class for simple contexts that scan their annotations from left to right.<a name="line.358"></a>
<span class="sourceLineNo">359</span>   */<a name="line.359"></a>
<span class="sourceLineNo">360</span>  private static abstract class LeftToRightContext extends Context_ImplBase {<a name="line.360"></a>
<span class="sourceLineNo">361</span><a name="line.361"></a>
<span class="sourceLineNo">362</span>    public LeftToRightContext(int begin, int end) {<a name="line.362"></a>
<span class="sourceLineNo">363</span>      super(begin, end);<a name="line.363"></a>
<span class="sourceLineNo">364</span>    }<a name="line.364"></a>
<span class="sourceLineNo">365</span><a name="line.365"></a>
<span class="sourceLineNo">366</span>    @Override<a name="line.366"></a>
<span class="sourceLineNo">367</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.367"></a>
<span class="sourceLineNo">368</span>        JCas jCas,<a name="line.368"></a>
<span class="sourceLineNo">369</span>        Annotation focusAnnotation,<a name="line.369"></a>
<span class="sourceLineNo">370</span>        Bounds bounds,<a name="line.370"></a>
<span class="sourceLineNo">371</span>        Class&lt;T&gt; annotationClass,<a name="line.371"></a>
<span class="sourceLineNo">372</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.372"></a>
<span class="sourceLineNo">373</span>      List&lt;T&gt; anns = this.select(jCas, focusAnnotation, annotationClass, this.end);<a name="line.373"></a>
<span class="sourceLineNo">374</span>      anns = anns.subList(this.begin, anns.size());<a name="line.374"></a>
<span class="sourceLineNo">375</span>      List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.375"></a>
<span class="sourceLineNo">376</span>      Iterator&lt;T&gt; iter = anns.iterator();<a name="line.376"></a>
<span class="sourceLineNo">377</span>      for (int pos = this.begin, oobPos = 1; pos &lt; this.end; pos += 1) {<a name="line.377"></a>
<span class="sourceLineNo">378</span>        T ann = iter.hasNext() ? iter.next() : null;<a name="line.378"></a>
<span class="sourceLineNo">379</span>        if (ann != null &amp;&amp; bounds.contains(ann)) {<a name="line.379"></a>
<span class="sourceLineNo">380</span>          for (Feature feature : extractor.extract(jCas, ann)) {<a name="line.380"></a>
<span class="sourceLineNo">381</span>            features.add(new ContextFeature(this.getName(), pos, feature));<a name="line.381"></a>
<span class="sourceLineNo">382</span>          }<a name="line.382"></a>
<span class="sourceLineNo">383</span>        } else {<a name="line.383"></a>
<span class="sourceLineNo">384</span>          features.add(new ContextFeature(this.getName(), pos, oobPos));<a name="line.384"></a>
<span class="sourceLineNo">385</span>          oobPos += 1;<a name="line.385"></a>
<span class="sourceLineNo">386</span>        }<a name="line.386"></a>
<span class="sourceLineNo">387</span>      }<a name="line.387"></a>
<span class="sourceLineNo">388</span>      return features;<a name="line.388"></a>
<span class="sourceLineNo">389</span>    }<a name="line.389"></a>
<span class="sourceLineNo">390</span>  }<a name="line.390"></a>
<span class="sourceLineNo">391</span><a name="line.391"></a>
<span class="sourceLineNo">392</span>  /**<a name="line.392"></a>
<span class="sourceLineNo">393</span>   * A {@link Context} for extracting the focus annotation. This is mainly useful when the focus<a name="line.393"></a>
<span class="sourceLineNo">394</span>   * annotation should be combined with other annotations using, e.g. a {@link Bag} or {@link Ngram}<a name="line.394"></a>
<span class="sourceLineNo">395</span>   * to aggregate over several contexts.<a name="line.395"></a>
<span class="sourceLineNo">396</span>   */<a name="line.396"></a>
<span class="sourceLineNo">397</span>  public static class Focus implements Context {<a name="line.397"></a>
<span class="sourceLineNo">398</span><a name="line.398"></a>
<span class="sourceLineNo">399</span>    private String name;<a name="line.399"></a>
<span class="sourceLineNo">400</span><a name="line.400"></a>
<span class="sourceLineNo">401</span>    /**<a name="line.401"></a>
<span class="sourceLineNo">402</span>     * Constructs a context that will extract features over the focus annotation.<a name="line.402"></a>
<span class="sourceLineNo">403</span>     */<a name="line.403"></a>
<span class="sourceLineNo">404</span>    public Focus() {<a name="line.404"></a>
<span class="sourceLineNo">405</span>      this.name = this.getClass().getSimpleName();<a name="line.405"></a>
<span class="sourceLineNo">406</span>    }<a name="line.406"></a>
<span class="sourceLineNo">407</span><a name="line.407"></a>
<span class="sourceLineNo">408</span>    @Override<a name="line.408"></a>
<span class="sourceLineNo">409</span>    public String getName() {<a name="line.409"></a>
<span class="sourceLineNo">410</span>      return this.name;<a name="line.410"></a>
<span class="sourceLineNo">411</span>    }<a name="line.411"></a>
<span class="sourceLineNo">412</span><a name="line.412"></a>
<span class="sourceLineNo">413</span>    @Override<a name="line.413"></a>
<span class="sourceLineNo">414</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.414"></a>
<span class="sourceLineNo">415</span>        JCas jCas,<a name="line.415"></a>
<span class="sourceLineNo">416</span>        Annotation focusAnnotation,<a name="line.416"></a>
<span class="sourceLineNo">417</span>        Bounds bounds,<a name="line.417"></a>
<span class="sourceLineNo">418</span>        Class&lt;T&gt; annotationClass,<a name="line.418"></a>
<span class="sourceLineNo">419</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.419"></a>
<span class="sourceLineNo">420</span>      if (!annotationClass.isInstance(focusAnnotation)) {<a name="line.420"></a>
<span class="sourceLineNo">421</span>        String message = "%s is not an instance of %s";<a name="line.421"></a>
<span class="sourceLineNo">422</span>        throw new IllegalArgumentException(String.format(message, focusAnnotation, annotationClass));<a name="line.422"></a>
<span class="sourceLineNo">423</span>      }<a name="line.423"></a>
<span class="sourceLineNo">424</span>      List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.424"></a>
<span class="sourceLineNo">425</span>      for (Feature feature : extractor.extract(jCas, focusAnnotation)) {<a name="line.425"></a>
<span class="sourceLineNo">426</span>        features.add(new ContextFeature(this.getName(), feature));<a name="line.426"></a>
<span class="sourceLineNo">427</span>      }<a name="line.427"></a>
<span class="sourceLineNo">428</span>      return features;<a name="line.428"></a>
<span class="sourceLineNo">429</span>    }<a name="line.429"></a>
<span class="sourceLineNo">430</span><a name="line.430"></a>
<span class="sourceLineNo">431</span>  }<a name="line.431"></a>
<span class="sourceLineNo">432</span><a name="line.432"></a>
<span class="sourceLineNo">433</span>  /**<a name="line.433"></a>
<span class="sourceLineNo">434</span>   * A {@link Context} for extracting annotations appearing before the focus annotation.<a name="line.434"></a>
<span class="sourceLineNo">435</span>   */<a name="line.435"></a>
<span class="sourceLineNo">436</span>  public static class Preceding extends RightToLeftContext {<a name="line.436"></a>
<span class="sourceLineNo">437</span><a name="line.437"></a>
<span class="sourceLineNo">438</span>    /**<a name="line.438"></a>
<span class="sourceLineNo">439</span>     * Constructs a context that will extract features over the preceding N annotations.<a name="line.439"></a>
<span class="sourceLineNo">440</span>     * <a name="line.440"></a>
<span class="sourceLineNo">441</span>     * @param end<a name="line.441"></a>
<span class="sourceLineNo">442</span>     *          The number of annotations to extract.<a name="line.442"></a>
<span class="sourceLineNo">443</span>     */<a name="line.443"></a>
<span class="sourceLineNo">444</span>    public Preceding(int end) {<a name="line.444"></a>
<span class="sourceLineNo">445</span>      super(0, end);<a name="line.445"></a>
<span class="sourceLineNo">446</span>    }<a name="line.446"></a>
<span class="sourceLineNo">447</span><a name="line.447"></a>
<span class="sourceLineNo">448</span>    /**<a name="line.448"></a>
<span class="sourceLineNo">449</span>     * Constructs a context that will extract features over a slice of the preceding N annotations.<a name="line.449"></a>
<span class="sourceLineNo">450</span>     * <a name="line.450"></a>
<span class="sourceLineNo">451</span>     * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the<a name="line.451"></a>
<span class="sourceLineNo">452</span>     * annotation immediately preceding the focus annotation. If either index is greater than the<a name="line.452"></a>
<span class="sourceLineNo">453</span>     * index of the earliest possible annotation, special "out of bounds" features will be added for<a name="line.453"></a>
<span class="sourceLineNo">454</span>     * each annotation that was requested but absent.<a name="line.454"></a>
<span class="sourceLineNo">455</span>     * <a name="line.455"></a>
<span class="sourceLineNo">456</span>     * @param begin<a name="line.456"></a>
<span class="sourceLineNo">457</span>     *          The index of the first annotation to include.<a name="line.457"></a>
<span class="sourceLineNo">458</span>     * @param end<a name="line.458"></a>
<span class="sourceLineNo">459</span>     *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.459"></a>
<span class="sourceLineNo">460</span>     */<a name="line.460"></a>
<span class="sourceLineNo">461</span>    public Preceding(int begin, int end) {<a name="line.461"></a>
<span class="sourceLineNo">462</span>      super(begin, end);<a name="line.462"></a>
<span class="sourceLineNo">463</span>    }<a name="line.463"></a>
<span class="sourceLineNo">464</span><a name="line.464"></a>
<span class="sourceLineNo">465</span>    @Override<a name="line.465"></a>
<span class="sourceLineNo">466</span>    protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.466"></a>
<span class="sourceLineNo">467</span>        JCas jCas,<a name="line.467"></a>
<span class="sourceLineNo">468</span>        Annotation focusAnnotation,<a name="line.468"></a>
<span class="sourceLineNo">469</span>        Class&lt;T&gt; annotationClass,<a name="line.469"></a>
<span class="sourceLineNo">470</span>        int count) {<a name="line.470"></a>
<span class="sourceLineNo">471</span>      return JCasUtil.selectPreceding(jCas, annotationClass, focusAnnotation, count);<a name="line.471"></a>
<span class="sourceLineNo">472</span>    }<a name="line.472"></a>
<span class="sourceLineNo">473</span>  }<a name="line.473"></a>
<span class="sourceLineNo">474</span><a name="line.474"></a>
<span class="sourceLineNo">475</span>  /**<a name="line.475"></a>
<span class="sourceLineNo">476</span>   * A {@link Context} for extracting annotations appearing after the focus annotation.<a name="line.476"></a>
<span class="sourceLineNo">477</span>   */<a name="line.477"></a>
<span class="sourceLineNo">478</span>  public static class Following extends LeftToRightContext {<a name="line.478"></a>
<span class="sourceLineNo">479</span><a name="line.479"></a>
<span class="sourceLineNo">480</span>    /**<a name="line.480"></a>
<span class="sourceLineNo">481</span>     * Constructs a context that will extract features over the following N annotations.<a name="line.481"></a>
<span class="sourceLineNo">482</span>     * <a name="line.482"></a>
<span class="sourceLineNo">483</span>     * @param end<a name="line.483"></a>
<span class="sourceLineNo">484</span>     *          The number of annotations to extract.<a name="line.484"></a>
<span class="sourceLineNo">485</span>     */<a name="line.485"></a>
<span class="sourceLineNo">486</span>    public Following(int end) {<a name="line.486"></a>
<span class="sourceLineNo">487</span>      super(0, end);<a name="line.487"></a>
<span class="sourceLineNo">488</span>    }<a name="line.488"></a>
<span class="sourceLineNo">489</span><a name="line.489"></a>
<span class="sourceLineNo">490</span>    /**<a name="line.490"></a>
<span class="sourceLineNo">491</span>     * Constructs a context that will extract features over a slice of the following N annotations.<a name="line.491"></a>
<span class="sourceLineNo">492</span>     * <a name="line.492"></a>
<span class="sourceLineNo">493</span>     * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the<a name="line.493"></a>
<span class="sourceLineNo">494</span>     * annotation immediately following the focus annotation. If either index is greater than the<a name="line.494"></a>
<span class="sourceLineNo">495</span>     * index of the last possible annotation, special "out of bounds" features will be added for<a name="line.495"></a>
<span class="sourceLineNo">496</span>     * each annotation that was requested but absent.<a name="line.496"></a>
<span class="sourceLineNo">497</span>     * <a name="line.497"></a>
<span class="sourceLineNo">498</span>     * @param begin<a name="line.498"></a>
<span class="sourceLineNo">499</span>     *          The index of the first annotation to include.<a name="line.499"></a>
<span class="sourceLineNo">500</span>     * @param end<a name="line.500"></a>
<span class="sourceLineNo">501</span>     *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.501"></a>
<span class="sourceLineNo">502</span>     */<a name="line.502"></a>
<span class="sourceLineNo">503</span>    public Following(int begin, int end) {<a name="line.503"></a>
<span class="sourceLineNo">504</span>      super(begin, end);<a name="line.504"></a>
<span class="sourceLineNo">505</span>    }<a name="line.505"></a>
<span class="sourceLineNo">506</span><a name="line.506"></a>
<span class="sourceLineNo">507</span>    @Override<a name="line.507"></a>
<span class="sourceLineNo">508</span>    protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.508"></a>
<span class="sourceLineNo">509</span>        JCas jCas,<a name="line.509"></a>
<span class="sourceLineNo">510</span>        Annotation focusAnnotation,<a name="line.510"></a>
<span class="sourceLineNo">511</span>        Class&lt;T&gt; annotationClass,<a name="line.511"></a>
<span class="sourceLineNo">512</span>        int count) {<a name="line.512"></a>
<span class="sourceLineNo">513</span>      return JCasUtil.selectFollowing(jCas, annotationClass, focusAnnotation, count);<a name="line.513"></a>
<span class="sourceLineNo">514</span>    }<a name="line.514"></a>
<span class="sourceLineNo">515</span>  }<a name="line.515"></a>
<span class="sourceLineNo">516</span><a name="line.516"></a>
<span class="sourceLineNo">517</span>  /**<a name="line.517"></a>
<span class="sourceLineNo">518</span>   * A {@link Context} for extracting all annotations within the focus annotation.<a name="line.518"></a>
<span class="sourceLineNo">519</span>   */<a name="line.519"></a>
<span class="sourceLineNo">520</span>  public static class Covered implements Context {<a name="line.520"></a>
<span class="sourceLineNo">521</span><a name="line.521"></a>
<span class="sourceLineNo">522</span>    /**<a name="line.522"></a>
<span class="sourceLineNo">523</span>     * Constructs a context that will extract features over all annotations within the focus<a name="line.523"></a>
<span class="sourceLineNo">524</span>     * annotation.<a name="line.524"></a>
<span class="sourceLineNo">525</span>     */<a name="line.525"></a>
<span class="sourceLineNo">526</span>    public Covered() {<a name="line.526"></a>
<span class="sourceLineNo">527</span>    }<a name="line.527"></a>
<span class="sourceLineNo">528</span><a name="line.528"></a>
<span class="sourceLineNo">529</span>    @Override<a name="line.529"></a>
<span class="sourceLineNo">530</span>    public String getName() {<a name="line.530"></a>
<span class="sourceLineNo">531</span>      return "Covered";<a name="line.531"></a>
<span class="sourceLineNo">532</span>    }<a name="line.532"></a>
<span class="sourceLineNo">533</span><a name="line.533"></a>
<span class="sourceLineNo">534</span>    @Override<a name="line.534"></a>
<span class="sourceLineNo">535</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.535"></a>
<span class="sourceLineNo">536</span>        JCas jCas,<a name="line.536"></a>
<span class="sourceLineNo">537</span>        Annotation focusAnnotation,<a name="line.537"></a>
<span class="sourceLineNo">538</span>        Bounds bounds,<a name="line.538"></a>
<span class="sourceLineNo">539</span>        Class&lt;T&gt; annotationClass,<a name="line.539"></a>
<span class="sourceLineNo">540</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.540"></a>
<span class="sourceLineNo">541</span>      List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.541"></a>
<span class="sourceLineNo">542</span>      int pos = 0;<a name="line.542"></a>
<span class="sourceLineNo">543</span>      for (T ann : JCasUtil.selectCovered(jCas, annotationClass, focusAnnotation)) {<a name="line.543"></a>
<span class="sourceLineNo">544</span>        for (Feature feature : extractor.extract(jCas, ann)) {<a name="line.544"></a>
<span class="sourceLineNo">545</span>          features.add(new ContextFeature(this.getName(), pos, feature));<a name="line.545"></a>
<span class="sourceLineNo">546</span>        }<a name="line.546"></a>
<span class="sourceLineNo">547</span>        pos += 1;<a name="line.547"></a>
<span class="sourceLineNo">548</span>      }<a name="line.548"></a>
<span class="sourceLineNo">549</span>      return features;<a name="line.549"></a>
<span class="sourceLineNo">550</span>    }<a name="line.550"></a>
<span class="sourceLineNo">551</span><a name="line.551"></a>
<span class="sourceLineNo">552</span>  }<a name="line.552"></a>
<span class="sourceLineNo">553</span><a name="line.553"></a>
<span class="sourceLineNo">554</span>  /**<a name="line.554"></a>
<span class="sourceLineNo">555</span>   * A {@link Context} for extracting the first annotations within the focus annotation.<a name="line.555"></a>
<span class="sourceLineNo">556</span>   */<a name="line.556"></a>
<span class="sourceLineNo">557</span>  public static class FirstCovered extends LeftToRightContext {<a name="line.557"></a>
<span class="sourceLineNo">558</span><a name="line.558"></a>
<span class="sourceLineNo">559</span>    /**<a name="line.559"></a>
<span class="sourceLineNo">560</span>     * Constructs a context that will extract features over the first N annotations within the focus<a name="line.560"></a>
<span class="sourceLineNo">561</span>     * annotation.<a name="line.561"></a>
<span class="sourceLineNo">562</span>     * <a name="line.562"></a>
<span class="sourceLineNo">563</span>     * @param end<a name="line.563"></a>
<span class="sourceLineNo">564</span>     *          The number of annotations to extract.<a name="line.564"></a>
<span class="sourceLineNo">565</span>     */<a name="line.565"></a>
<span class="sourceLineNo">566</span>    public FirstCovered(int end) {<a name="line.566"></a>
<span class="sourceLineNo">567</span>      super(0, end);<a name="line.567"></a>
<span class="sourceLineNo">568</span>    }<a name="line.568"></a>
<span class="sourceLineNo">569</span><a name="line.569"></a>
<span class="sourceLineNo">570</span>    /**<a name="line.570"></a>
<span class="sourceLineNo">571</span>     * Constructs a context that will extract features over a slice of the first N annotations<a name="line.571"></a>
<span class="sourceLineNo">572</span>     * within the focus annotation.<a name="line.572"></a>
<span class="sourceLineNo">573</span>     * <a name="line.573"></a>
<span class="sourceLineNo">574</span>     * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the first<a name="line.574"></a>
<span class="sourceLineNo">575</span>     * annotation within the focus annotation. If either index is greater than the index of the last<a name="line.575"></a>
<span class="sourceLineNo">576</span>     * annotation within the focus annotation, special "out of bounds" features will be added for<a name="line.576"></a>
<span class="sourceLineNo">577</span>     * each annotation that was requested but absent.<a name="line.577"></a>
<span class="sourceLineNo">578</span>     * <a name="line.578"></a>
<span class="sourceLineNo">579</span>     * @param begin<a name="line.579"></a>
<span class="sourceLineNo">580</span>     *          The index of the first annotation to include.<a name="line.580"></a>
<span class="sourceLineNo">581</span>     * @param end<a name="line.581"></a>
<span class="sourceLineNo">582</span>     *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.582"></a>
<span class="sourceLineNo">583</span>     */<a name="line.583"></a>
<span class="sourceLineNo">584</span>    public FirstCovered(int begin, int end) {<a name="line.584"></a>
<span class="sourceLineNo">585</span>      super(begin, end);<a name="line.585"></a>
<span class="sourceLineNo">586</span>    }<a name="line.586"></a>
<span class="sourceLineNo">587</span><a name="line.587"></a>
<span class="sourceLineNo">588</span>    @Override<a name="line.588"></a>
<span class="sourceLineNo">589</span>    protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.589"></a>
<span class="sourceLineNo">590</span>        JCas jCas,<a name="line.590"></a>
<span class="sourceLineNo">591</span>        Annotation focusAnnotation,<a name="line.591"></a>
<span class="sourceLineNo">592</span>        Class&lt;T&gt; annotationClass,<a name="line.592"></a>
<span class="sourceLineNo">593</span>        int count) {<a name="line.593"></a>
<span class="sourceLineNo">594</span>      List&lt;T&gt; anns = JCasUtil.selectCovered(jCas, annotationClass, focusAnnotation);<a name="line.594"></a>
<span class="sourceLineNo">595</span>      return anns.subList(0, Math.min(count, anns.size()));<a name="line.595"></a>
<span class="sourceLineNo">596</span>    }<a name="line.596"></a>
<span class="sourceLineNo">597</span>  }<a name="line.597"></a>
<span class="sourceLineNo">598</span><a name="line.598"></a>
<span class="sourceLineNo">599</span>  /**<a name="line.599"></a>
<span class="sourceLineNo">600</span>   * A {@link Context} for extracting the last annotations within the focus annotation.<a name="line.600"></a>
<span class="sourceLineNo">601</span>   */<a name="line.601"></a>
<span class="sourceLineNo">602</span>  public static class LastCovered extends RightToLeftContext {<a name="line.602"></a>
<span class="sourceLineNo">603</span><a name="line.603"></a>
<span class="sourceLineNo">604</span>    /**<a name="line.604"></a>
<span class="sourceLineNo">605</span>     * Constructs a context that will extract features over the last N annotations within the focus<a name="line.605"></a>
<span class="sourceLineNo">606</span>     * annotation.<a name="line.606"></a>
<span class="sourceLineNo">607</span>     * <a name="line.607"></a>
<span class="sourceLineNo">608</span>     * @param end<a name="line.608"></a>
<span class="sourceLineNo">609</span>     *          The number of annotations to extract.<a name="line.609"></a>
<span class="sourceLineNo">610</span>     */<a name="line.610"></a>
<span class="sourceLineNo">611</span>    public LastCovered(int end) {<a name="line.611"></a>
<span class="sourceLineNo">612</span>      super(0, end);<a name="line.612"></a>
<span class="sourceLineNo">613</span>    }<a name="line.613"></a>
<span class="sourceLineNo">614</span><a name="line.614"></a>
<span class="sourceLineNo">615</span>    /**<a name="line.615"></a>
<span class="sourceLineNo">616</span>     * Constructs a context that will extract features over a slice of the last N annotations within<a name="line.616"></a>
<span class="sourceLineNo">617</span>     * the focus annotation.<a name="line.617"></a>
<span class="sourceLineNo">618</span>     * <a name="line.618"></a>
<span class="sourceLineNo">619</span>     * The {@code begin} and {@code end} indexes count from 0, where index 0 identifies the last<a name="line.619"></a>
<span class="sourceLineNo">620</span>     * annotation within the focus annotation. If either index is greater than the index of the<a name="line.620"></a>
<span class="sourceLineNo">621</span>     * first annotation within the focus annotation, special "out of bounds" features will be added<a name="line.621"></a>
<span class="sourceLineNo">622</span>     * for each annotation that was requested but absent.<a name="line.622"></a>
<span class="sourceLineNo">623</span>     * <a name="line.623"></a>
<span class="sourceLineNo">624</span>     * @param begin<a name="line.624"></a>
<span class="sourceLineNo">625</span>     *          The index of the first annotation to include.<a name="line.625"></a>
<span class="sourceLineNo">626</span>     * @param end<a name="line.626"></a>
<span class="sourceLineNo">627</span>     *          The index of the last annotation to include. Must be greater than {@code begin}.<a name="line.627"></a>
<span class="sourceLineNo">628</span>     */<a name="line.628"></a>
<span class="sourceLineNo">629</span>    public LastCovered(int begin, int end) {<a name="line.629"></a>
<span class="sourceLineNo">630</span>      super(begin, end);<a name="line.630"></a>
<span class="sourceLineNo">631</span>    }<a name="line.631"></a>
<span class="sourceLineNo">632</span><a name="line.632"></a>
<span class="sourceLineNo">633</span>    @Override<a name="line.633"></a>
<span class="sourceLineNo">634</span>    protected &lt;T extends Annotation&gt; List&lt;T&gt; select(<a name="line.634"></a>
<span class="sourceLineNo">635</span>        JCas jCas,<a name="line.635"></a>
<span class="sourceLineNo">636</span>        Annotation focusAnnotation,<a name="line.636"></a>
<span class="sourceLineNo">637</span>        Class&lt;T&gt; annotationClass,<a name="line.637"></a>
<span class="sourceLineNo">638</span>        int count) {<a name="line.638"></a>
<span class="sourceLineNo">639</span>      List&lt;T&gt; anns = JCasUtil.selectCovered(jCas, annotationClass, focusAnnotation);<a name="line.639"></a>
<span class="sourceLineNo">640</span>      return anns.subList(Math.max(anns.size() - count, 0), anns.size());<a name="line.640"></a>
<span class="sourceLineNo">641</span>    }<a name="line.641"></a>
<span class="sourceLineNo">642</span>  }<a name="line.642"></a>
<span class="sourceLineNo">643</span><a name="line.643"></a>
<span class="sourceLineNo">644</span>  /**<a name="line.644"></a>
<span class="sourceLineNo">645</span>   * A {@link Context} that aggregates the features of other contexts into a "bag" where position<a name="line.645"></a>
<span class="sourceLineNo">646</span>   * information of each individual feature is no longer maintained. Position information is not<a name="line.646"></a>
<span class="sourceLineNo">647</span>   * entirely lost - the span of the bag is encoded as part of the feature name that is shared by<a name="line.647"></a>
<span class="sourceLineNo">648</span>   * all of the features within the bag.<a name="line.648"></a>
<span class="sourceLineNo">649</span>   */<a name="line.649"></a>
<span class="sourceLineNo">650</span>  public static class Bag implements Context {<a name="line.650"></a>
<span class="sourceLineNo">651</span><a name="line.651"></a>
<span class="sourceLineNo">652</span>    private Context[] contexts;<a name="line.652"></a>
<span class="sourceLineNo">653</span><a name="line.653"></a>
<span class="sourceLineNo">654</span>    private String name;<a name="line.654"></a>
<span class="sourceLineNo">655</span><a name="line.655"></a>
<span class="sourceLineNo">656</span>    /**<a name="line.656"></a>
<span class="sourceLineNo">657</span>     * Constructs a {@link Context} which converts the features extracted by the argument contexts<a name="line.657"></a>
<span class="sourceLineNo">658</span>     * into a bag of features where all features have the same name.<a name="line.658"></a>
<span class="sourceLineNo">659</span>     * <a name="line.659"></a>
<span class="sourceLineNo">660</span>     * @param contexts<a name="line.660"></a>
<span class="sourceLineNo">661</span>     *          The contexts which should be combined into a bag.<a name="line.661"></a>
<span class="sourceLineNo">662</span>     */<a name="line.662"></a>
<span class="sourceLineNo">663</span>    public Bag(Context... contexts) {<a name="line.663"></a>
<span class="sourceLineNo">664</span>      this.contexts = contexts;<a name="line.664"></a>
<span class="sourceLineNo">665</span>      String[] names = new String[contexts.length + 1];<a name="line.665"></a>
<span class="sourceLineNo">666</span>      names[0] = "Bag";<a name="line.666"></a>
<span class="sourceLineNo">667</span>      for (int i = 1; i &lt; names.length; ++i) {<a name="line.667"></a>
<span class="sourceLineNo">668</span>        names[i] = contexts[i - 1].getName();<a name="line.668"></a>
<span class="sourceLineNo">669</span>      }<a name="line.669"></a>
<span class="sourceLineNo">670</span>      this.name = Feature.createName(names);<a name="line.670"></a>
<span class="sourceLineNo">671</span>    }<a name="line.671"></a>
<span class="sourceLineNo">672</span><a name="line.672"></a>
<span class="sourceLineNo">673</span>    @Override<a name="line.673"></a>
<span class="sourceLineNo">674</span>    public String getName() {<a name="line.674"></a>
<span class="sourceLineNo">675</span>      return this.name;<a name="line.675"></a>
<span class="sourceLineNo">676</span>    }<a name="line.676"></a>
<span class="sourceLineNo">677</span><a name="line.677"></a>
<span class="sourceLineNo">678</span>    @Override<a name="line.678"></a>
<span class="sourceLineNo">679</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.679"></a>
<span class="sourceLineNo">680</span>        JCas jCas,<a name="line.680"></a>
<span class="sourceLineNo">681</span>        Annotation focusAnnotation,<a name="line.681"></a>
<span class="sourceLineNo">682</span>        Bounds bounds,<a name="line.682"></a>
<span class="sourceLineNo">683</span>        Class&lt;T&gt; annotationClass,<a name="line.683"></a>
<span class="sourceLineNo">684</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.684"></a>
<span class="sourceLineNo">685</span>      List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.685"></a>
<span class="sourceLineNo">686</span>      for (Context context : this.contexts) {<a name="line.686"></a>
<span class="sourceLineNo">687</span>        for (Feature feature : context.extract(<a name="line.687"></a>
<span class="sourceLineNo">688</span>            jCas,<a name="line.688"></a>
<span class="sourceLineNo">689</span>            focusAnnotation,<a name="line.689"></a>
<span class="sourceLineNo">690</span>            bounds,<a name="line.690"></a>
<span class="sourceLineNo">691</span>            annotationClass,<a name="line.691"></a>
<span class="sourceLineNo">692</span>            extractor)) {<a name="line.692"></a>
<span class="sourceLineNo">693</span>          ContextFeature contextFeature = (ContextFeature) feature;<a name="line.693"></a>
<span class="sourceLineNo">694</span>          String fName = Feature.createName(this.name, contextFeature.feature.getName());<a name="line.694"></a>
<span class="sourceLineNo">695</span>          features.add(new Feature(fName, feature.getValue()));<a name="line.695"></a>
<span class="sourceLineNo">696</span>        }<a name="line.696"></a>
<span class="sourceLineNo">697</span>      }<a name="line.697"></a>
<span class="sourceLineNo">698</span>      return features;<a name="line.698"></a>
<span class="sourceLineNo">699</span>    }<a name="line.699"></a>
<span class="sourceLineNo">700</span>  }<a name="line.700"></a>
<span class="sourceLineNo">701</span><a name="line.701"></a>
<span class="sourceLineNo">702</span>  /**<a name="line.702"></a>
<span class="sourceLineNo">703</span>   * A {@link Context} that aggregates the features of other contexts into a bag of counts where<a name="line.703"></a>
<span class="sourceLineNo">704</span>   * only the count of occurrence of each feature value is maintained. The span (offsets) of the bag<a name="line.704"></a>
<span class="sourceLineNo">705</span>   * of counts is encoded as part of the feature name.<a name="line.705"></a>
<span class="sourceLineNo">706</span>   */<a name="line.706"></a>
<span class="sourceLineNo">707</span>  public static class Count implements Context {<a name="line.707"></a>
<span class="sourceLineNo">708</span><a name="line.708"></a>
<span class="sourceLineNo">709</span>    private Context[] contexts;<a name="line.709"></a>
<span class="sourceLineNo">710</span><a name="line.710"></a>
<span class="sourceLineNo">711</span>    private String name;<a name="line.711"></a>
<span class="sourceLineNo">712</span><a name="line.712"></a>
<span class="sourceLineNo">713</span>    /**<a name="line.713"></a>
<span class="sourceLineNo">714</span>     * Constructs a {@link Context} which converts the features extracted by the argument contexts<a name="line.714"></a>
<span class="sourceLineNo">715</span>     * into a bag of count features.<a name="line.715"></a>
<span class="sourceLineNo">716</span>     * <a name="line.716"></a>
<span class="sourceLineNo">717</span>     * @param contexts<a name="line.717"></a>
<span class="sourceLineNo">718</span>     *          The contexts which should be combined into a bag.<a name="line.718"></a>
<span class="sourceLineNo">719</span>     */<a name="line.719"></a>
<span class="sourceLineNo">720</span>    public Count(Context... contexts) {<a name="line.720"></a>
<span class="sourceLineNo">721</span>      this.contexts = contexts;<a name="line.721"></a>
<span class="sourceLineNo">722</span>      String[] names = new String[contexts.length + 1];<a name="line.722"></a>
<span class="sourceLineNo">723</span>      names[0] = "Count";<a name="line.723"></a>
<span class="sourceLineNo">724</span>      for (int i = 1; i &lt; names.length; ++i) {<a name="line.724"></a>
<span class="sourceLineNo">725</span>        names[i] = contexts[i - 1].getName();<a name="line.725"></a>
<span class="sourceLineNo">726</span>      }<a name="line.726"></a>
<span class="sourceLineNo">727</span>      this.name = Feature.createName(names);<a name="line.727"></a>
<span class="sourceLineNo">728</span>    }<a name="line.728"></a>
<span class="sourceLineNo">729</span><a name="line.729"></a>
<span class="sourceLineNo">730</span>    @Override<a name="line.730"></a>
<span class="sourceLineNo">731</span>    public String getName() {<a name="line.731"></a>
<span class="sourceLineNo">732</span>      return this.name;<a name="line.732"></a>
<span class="sourceLineNo">733</span>    }<a name="line.733"></a>
<span class="sourceLineNo">734</span><a name="line.734"></a>
<span class="sourceLineNo">735</span>    @Override<a name="line.735"></a>
<span class="sourceLineNo">736</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.736"></a>
<span class="sourceLineNo">737</span>        JCas jCas,<a name="line.737"></a>
<span class="sourceLineNo">738</span>        Annotation focusAnnotation,<a name="line.738"></a>
<span class="sourceLineNo">739</span>        Bounds bounds,<a name="line.739"></a>
<span class="sourceLineNo">740</span>        Class&lt;T&gt; annotationClass,<a name="line.740"></a>
<span class="sourceLineNo">741</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.741"></a>
<span class="sourceLineNo">742</span>      Multiset&lt;String&gt; featureCounts = LinkedHashMultiset.create();<a name="line.742"></a>
<span class="sourceLineNo">743</span>      for (Context context : this.contexts) {<a name="line.743"></a>
<span class="sourceLineNo">744</span>        for (Feature feature : context.extract(<a name="line.744"></a>
<span class="sourceLineNo">745</span>            jCas,<a name="line.745"></a>
<span class="sourceLineNo">746</span>            focusAnnotation,<a name="line.746"></a>
<span class="sourceLineNo">747</span>            bounds,<a name="line.747"></a>
<span class="sourceLineNo">748</span>            annotationClass,<a name="line.748"></a>
<span class="sourceLineNo">749</span>            extractor)) {<a name="line.749"></a>
<span class="sourceLineNo">750</span>          ContextFeature contextFeature = (ContextFeature) feature;<a name="line.750"></a>
<span class="sourceLineNo">751</span>          String featureName = Feature.createName(<a name="line.751"></a>
<span class="sourceLineNo">752</span>              this.name,<a name="line.752"></a>
<span class="sourceLineNo">753</span>              contextFeature.feature.getName(),<a name="line.753"></a>
<span class="sourceLineNo">754</span>              String.valueOf(feature.getValue()));<a name="line.754"></a>
<span class="sourceLineNo">755</span>          featureCounts.add(featureName);<a name="line.755"></a>
<span class="sourceLineNo">756</span>        }<a name="line.756"></a>
<span class="sourceLineNo">757</span>      }<a name="line.757"></a>
<span class="sourceLineNo">758</span>      List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.758"></a>
<span class="sourceLineNo">759</span>      for (String featureName : featureCounts.elementSet()) {<a name="line.759"></a>
<span class="sourceLineNo">760</span>        features.add(new Feature(featureName, featureCounts.count(featureName)));<a name="line.760"></a>
<span class="sourceLineNo">761</span>      }<a name="line.761"></a>
<span class="sourceLineNo">762</span>      return features;<a name="line.762"></a>
<span class="sourceLineNo">763</span>    }<a name="line.763"></a>
<span class="sourceLineNo">764</span>  }<a name="line.764"></a>
<span class="sourceLineNo">765</span><a name="line.765"></a>
<span class="sourceLineNo">766</span>  /**<a name="line.766"></a>
<span class="sourceLineNo">767</span>   * A {@link Context} that aggregates the features of other contexts into a single "ngram" feature,<a name="line.767"></a>
<span class="sourceLineNo">768</span>   * where the feature values are concatenated together in order to form a single value.<a name="line.768"></a>
<span class="sourceLineNo">769</span>   */<a name="line.769"></a>
<span class="sourceLineNo">770</span>  public static class Ngram implements Context {<a name="line.770"></a>
<span class="sourceLineNo">771</span>    private Context[] contexts;<a name="line.771"></a>
<span class="sourceLineNo">772</span><a name="line.772"></a>
<span class="sourceLineNo">773</span>    private String name;<a name="line.773"></a>
<span class="sourceLineNo">774</span><a name="line.774"></a>
<span class="sourceLineNo">775</span>    /**<a name="line.775"></a>
<span class="sourceLineNo">776</span>     * Constructs a {@link Context} which converts the features extracted by the argument contexts<a name="line.776"></a>
<span class="sourceLineNo">777</span>     * into a single ngram feature where all feature values have been concatenated together.<a name="line.777"></a>
<span class="sourceLineNo">778</span>     * <a name="line.778"></a>
<span class="sourceLineNo">779</span>     * @param contexts<a name="line.779"></a>
<span class="sourceLineNo">780</span>     *          The contexts which should be combined into an ngram.<a name="line.780"></a>
<span class="sourceLineNo">781</span>     */<a name="line.781"></a>
<span class="sourceLineNo">782</span>    public Ngram(Context... contexts) {<a name="line.782"></a>
<span class="sourceLineNo">783</span>      this.contexts = contexts;<a name="line.783"></a>
<span class="sourceLineNo">784</span>      String[] names = new String[contexts.length + 1];<a name="line.784"></a>
<span class="sourceLineNo">785</span>      names[0] = "Ngram";<a name="line.785"></a>
<span class="sourceLineNo">786</span>      for (int i = 1; i &lt; names.length; ++i) {<a name="line.786"></a>
<span class="sourceLineNo">787</span>        names[i] = contexts[i - 1].getName();<a name="line.787"></a>
<span class="sourceLineNo">788</span>      }<a name="line.788"></a>
<span class="sourceLineNo">789</span>      this.name = Feature.createName(names);<a name="line.789"></a>
<span class="sourceLineNo">790</span>    }<a name="line.790"></a>
<span class="sourceLineNo">791</span><a name="line.791"></a>
<span class="sourceLineNo">792</span>    @Override<a name="line.792"></a>
<span class="sourceLineNo">793</span>    public String getName() {<a name="line.793"></a>
<span class="sourceLineNo">794</span>      return this.name;<a name="line.794"></a>
<span class="sourceLineNo">795</span>    }<a name="line.795"></a>
<span class="sourceLineNo">796</span><a name="line.796"></a>
<span class="sourceLineNo">797</span>    @Override<a name="line.797"></a>
<span class="sourceLineNo">798</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.798"></a>
<span class="sourceLineNo">799</span>        JCas jCas,<a name="line.799"></a>
<span class="sourceLineNo">800</span>        Annotation focusAnnotation,<a name="line.800"></a>
<span class="sourceLineNo">801</span>        Bounds bounds,<a name="line.801"></a>
<span class="sourceLineNo">802</span>        Class&lt;T&gt; annotationClass,<a name="line.802"></a>
<span class="sourceLineNo">803</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.803"></a>
<span class="sourceLineNo">804</span>      List&lt;String&gt; values = new ArrayList&lt;String&gt;();<a name="line.804"></a>
<span class="sourceLineNo">805</span>      for (Context context : this.contexts) {<a name="line.805"></a>
<span class="sourceLineNo">806</span>        for (Feature feature : context.extract(<a name="line.806"></a>
<span class="sourceLineNo">807</span>            jCas,<a name="line.807"></a>
<span class="sourceLineNo">808</span>            focusAnnotation,<a name="line.808"></a>
<span class="sourceLineNo">809</span>            bounds,<a name="line.809"></a>
<span class="sourceLineNo">810</span>            annotationClass,<a name="line.810"></a>
<span class="sourceLineNo">811</span>            extractor)) {<a name="line.811"></a>
<span class="sourceLineNo">812</span>          values.add(String.valueOf(feature.getValue()));<a name="line.812"></a>
<span class="sourceLineNo">813</span>        }<a name="line.813"></a>
<span class="sourceLineNo">814</span>      }<a name="line.814"></a>
<span class="sourceLineNo">815</span>      return Arrays.asList(new Feature(this.name, StringUtils.join(values, '_')));<a name="line.815"></a>
<span class="sourceLineNo">816</span>    }<a name="line.816"></a>
<span class="sourceLineNo">817</span>  }<a name="line.817"></a>
<span class="sourceLineNo">818</span><a name="line.818"></a>
<span class="sourceLineNo">819</span>  /**<a name="line.819"></a>
<span class="sourceLineNo">820</span>   * A {@link Context} that aggregates the features of other contexts into several "ngrams"<a name="line.820"></a>
<span class="sourceLineNo">821</span>   * features, where sub-sequences of the feature values are concatenated together in order to form<a name="line.821"></a>
<span class="sourceLineNo">822</span>   * single values.<a name="line.822"></a>
<span class="sourceLineNo">823</span>   */<a name="line.823"></a>
<span class="sourceLineNo">824</span>  public static class Ngrams implements Context {<a name="line.824"></a>
<span class="sourceLineNo">825</span>    private int n;<a name="line.825"></a>
<span class="sourceLineNo">826</span><a name="line.826"></a>
<span class="sourceLineNo">827</span>    private Context[] contexts;<a name="line.827"></a>
<span class="sourceLineNo">828</span><a name="line.828"></a>
<span class="sourceLineNo">829</span>    private String name;<a name="line.829"></a>
<span class="sourceLineNo">830</span><a name="line.830"></a>
<span class="sourceLineNo">831</span>    /**<a name="line.831"></a>
<span class="sourceLineNo">832</span>     * Constructs a {@link Context} which converts the features extracted by the argument contexts<a name="line.832"></a>
<span class="sourceLineNo">833</span>     * into ngram features where sub-sequences feature values have been concatenated together.<a name="line.833"></a>
<span class="sourceLineNo">834</span>     * <a name="line.834"></a>
<span class="sourceLineNo">835</span>     * For example, Ngrams(2, context) will extract all bigrams of features generated in the given<a name="line.835"></a>
<span class="sourceLineNo">836</span>     * context.<a name="line.836"></a>
<span class="sourceLineNo">837</span>     * <a name="line.837"></a>
<span class="sourceLineNo">838</span>     * @param n<a name="line.838"></a>
<span class="sourceLineNo">839</span>     *          The length of the n-gram features<a name="line.839"></a>
<span class="sourceLineNo">840</span>     * @param contexts<a name="line.840"></a>
<span class="sourceLineNo">841</span>     *          The contexts which should be combined into an ngram.<a name="line.841"></a>
<span class="sourceLineNo">842</span>     */<a name="line.842"></a>
<span class="sourceLineNo">843</span>    public Ngrams(int n, Context... contexts) {<a name="line.843"></a>
<span class="sourceLineNo">844</span>      this.n = n;<a name="line.844"></a>
<span class="sourceLineNo">845</span>      this.contexts = contexts;<a name="line.845"></a>
<span class="sourceLineNo">846</span>      String[] names = new String[contexts.length + 1];<a name="line.846"></a>
<span class="sourceLineNo">847</span>      names[0] = this.n + "grams";<a name="line.847"></a>
<span class="sourceLineNo">848</span>      for (int i = 1; i &lt; names.length; ++i) {<a name="line.848"></a>
<span class="sourceLineNo">849</span>        names[i] = contexts[i - 1].getName();<a name="line.849"></a>
<span class="sourceLineNo">850</span>      }<a name="line.850"></a>
<span class="sourceLineNo">851</span>      this.name = Feature.createName(names);<a name="line.851"></a>
<span class="sourceLineNo">852</span>    }<a name="line.852"></a>
<span class="sourceLineNo">853</span><a name="line.853"></a>
<span class="sourceLineNo">854</span>    @Override<a name="line.854"></a>
<span class="sourceLineNo">855</span>    public String getName() {<a name="line.855"></a>
<span class="sourceLineNo">856</span>      return this.name;<a name="line.856"></a>
<span class="sourceLineNo">857</span>    }<a name="line.857"></a>
<span class="sourceLineNo">858</span><a name="line.858"></a>
<span class="sourceLineNo">859</span>    @Override<a name="line.859"></a>
<span class="sourceLineNo">860</span>    public &lt;T extends Annotation&gt; List&lt;Feature&gt; extract(<a name="line.860"></a>
<span class="sourceLineNo">861</span>        JCas jCas,<a name="line.861"></a>
<span class="sourceLineNo">862</span>        Annotation focusAnnotation,<a name="line.862"></a>
<span class="sourceLineNo">863</span>        Bounds bounds,<a name="line.863"></a>
<span class="sourceLineNo">864</span>        Class&lt;T&gt; annotationClass,<a name="line.864"></a>
<span class="sourceLineNo">865</span>        SimpleFeatureExtractor extractor) throws CleartkExtractorException {<a name="line.865"></a>
<span class="sourceLineNo">866</span>      List&lt;Feature&gt; extractedFeatures = new ArrayList&lt;Feature&gt;();<a name="line.866"></a>
<span class="sourceLineNo">867</span>      for (Context context : this.contexts) {<a name="line.867"></a>
<span class="sourceLineNo">868</span>        extractedFeatures.addAll(context.extract(<a name="line.868"></a>
<span class="sourceLineNo">869</span>            jCas,<a name="line.869"></a>
<span class="sourceLineNo">870</span>            focusAnnotation,<a name="line.870"></a>
<span class="sourceLineNo">871</span>            bounds,<a name="line.871"></a>
<span class="sourceLineNo">872</span>            annotationClass,<a name="line.872"></a>
<span class="sourceLineNo">873</span>            extractor));<a name="line.873"></a>
<span class="sourceLineNo">874</span>      }<a name="line.874"></a>
<span class="sourceLineNo">875</span>      List&lt;Feature&gt; features = new ArrayList&lt;Feature&gt;();<a name="line.875"></a>
<span class="sourceLineNo">876</span>      for (int i = 0; i &lt; extractedFeatures.size() - this.n + 1; ++i) {<a name="line.876"></a>
<span class="sourceLineNo">877</span>        List&lt;String&gt; values = new ArrayList&lt;String&gt;();<a name="line.877"></a>
<span class="sourceLineNo">878</span>        for (Feature feature : extractedFeatures.subList(i, i + this.n)) {<a name="line.878"></a>
<span class="sourceLineNo">879</span>          values.add(feature.getValue().toString());<a name="line.879"></a>
<span class="sourceLineNo">880</span>        }<a name="line.880"></a>
<span class="sourceLineNo">881</span>        features.add(new Feature(this.name, Joiner.on('_').join(values)));<a name="line.881"></a>
<span class="sourceLineNo">882</span>      }<a name="line.882"></a>
<span class="sourceLineNo">883</span>      return features;<a name="line.883"></a>
<span class="sourceLineNo">884</span>    }<a name="line.884"></a>
<span class="sourceLineNo">885</span>  }<a name="line.885"></a>
<span class="sourceLineNo">886</span>}<a name="line.886"></a>




























































</pre>
</div>
</body>
</html>
