<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>/** <a name="line.1"></a>
<span class="sourceLineNo">002</span> * Copyright (c) 2007-2008, Regents of the University of Colorado <a name="line.2"></a>
<span class="sourceLineNo">003</span> * All rights reserved.<a name="line.3"></a>
<span class="sourceLineNo">004</span> * <a name="line.4"></a>
<span class="sourceLineNo">005</span> * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<span class="sourceLineNo">006</span> * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<span class="sourceLineNo">007</span> * <a name="line.7"></a>
<span class="sourceLineNo">008</span> * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<span class="sourceLineNo">009</span> * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<span class="sourceLineNo">010</span> * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<span class="sourceLineNo">011</span> * <a name="line.11"></a>
<span class="sourceLineNo">012</span> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<span class="sourceLineNo">013</span> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<span class="sourceLineNo">014</span> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<span class="sourceLineNo">015</span> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<span class="sourceLineNo">016</span> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<span class="sourceLineNo">017</span> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<span class="sourceLineNo">018</span> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<span class="sourceLineNo">019</span> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<span class="sourceLineNo">020</span> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<span class="sourceLineNo">021</span> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<span class="sourceLineNo">022</span> * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<span class="sourceLineNo">023</span> */<a name="line.23"></a>
<span class="sourceLineNo">024</span>package org.cleartk.classifier.feature.extractor.simple;<a name="line.24"></a>
<span class="sourceLineNo">025</span><a name="line.25"></a>
<span class="sourceLineNo">026</span>import java.util.ArrayList;<a name="line.26"></a>
<span class="sourceLineNo">027</span>import java.util.Arrays;<a name="line.27"></a>
<span class="sourceLineNo">028</span>import java.util.HashSet;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import java.util.List;<a name="line.29"></a>
<span class="sourceLineNo">030</span>import java.util.Set;<a name="line.30"></a>
<span class="sourceLineNo">031</span>import java.util.logging.Logger;<a name="line.31"></a>
<span class="sourceLineNo">032</span><a name="line.32"></a>
<span class="sourceLineNo">033</span>import org.apache.uima.cas.ArrayFS;<a name="line.33"></a>
<span class="sourceLineNo">034</span>import org.apache.uima.cas.Feature;<a name="line.34"></a>
<span class="sourceLineNo">035</span>import org.apache.uima.cas.FeatureStructure;<a name="line.35"></a>
<span class="sourceLineNo">036</span>import org.apache.uima.cas.Type;<a name="line.36"></a>
<span class="sourceLineNo">037</span>import org.apache.uima.cas.TypeSystem;<a name="line.37"></a>
<span class="sourceLineNo">038</span>import org.apache.uima.jcas.JCas;<a name="line.38"></a>
<span class="sourceLineNo">039</span>import org.apache.uima.jcas.cas.BooleanArray;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import org.apache.uima.jcas.cas.ByteArray;<a name="line.40"></a>
<span class="sourceLineNo">041</span>import org.apache.uima.jcas.cas.DoubleArray;<a name="line.41"></a>
<span class="sourceLineNo">042</span>import org.apache.uima.jcas.cas.FSArray;<a name="line.42"></a>
<span class="sourceLineNo">043</span>import org.apache.uima.jcas.cas.FloatArray;<a name="line.43"></a>
<span class="sourceLineNo">044</span>import org.apache.uima.jcas.cas.IntegerArray;<a name="line.44"></a>
<span class="sourceLineNo">045</span>import org.apache.uima.jcas.cas.LongArray;<a name="line.45"></a>
<span class="sourceLineNo">046</span>import org.apache.uima.jcas.cas.ShortArray;<a name="line.46"></a>
<span class="sourceLineNo">047</span>import org.apache.uima.jcas.cas.StringArray;<a name="line.47"></a>
<span class="sourceLineNo">048</span>import org.apache.uima.jcas.tcas.Annotation;<a name="line.48"></a>
<span class="sourceLineNo">049</span>import org.cleartk.classifier.feature.extractor.CleartkExtractorException;<a name="line.49"></a>
<span class="sourceLineNo">050</span>import org.cleartk.util.UIMAUtil;<a name="line.50"></a>
<span class="sourceLineNo">051</span><a name="line.51"></a>
<span class="sourceLineNo">052</span>/**<a name="line.52"></a>
<span class="sourceLineNo">053</span> * &lt;br&gt;<a name="line.53"></a>
<span class="sourceLineNo">054</span> * Copyright (c) 2007-2008, Regents of the University of Colorado &lt;br&gt;<a name="line.54"></a>
<span class="sourceLineNo">055</span> * All rights reserved.<a name="line.55"></a>
<span class="sourceLineNo">056</span> * <a name="line.56"></a>
<span class="sourceLineNo">057</span> * &lt;p&gt;<a name="line.57"></a>
<span class="sourceLineNo">058</span> * <a name="line.58"></a>
<span class="sourceLineNo">059</span> * @author Philip Ogren<a name="line.59"></a>
<span class="sourceLineNo">060</span> * <a name="line.60"></a>
<span class="sourceLineNo">061</span> *         TODO handle cases where the pathValue is not a String so that they are not necessarily<a name="line.61"></a>
<span class="sourceLineNo">062</span> *         converted to strings<a name="line.62"></a>
<span class="sourceLineNo">063</span> */<a name="line.63"></a>
<span class="sourceLineNo">064</span><a name="line.64"></a>
<span class="sourceLineNo">065</span>public class TypePathExtractor implements SimpleFeatureExtractor {<a name="line.65"></a>
<span class="sourceLineNo">066</span>  Class&lt;? extends Annotation&gt; focusClass;<a name="line.66"></a>
<span class="sourceLineNo">067</span><a name="line.67"></a>
<span class="sourceLineNo">068</span>  Type type;<a name="line.68"></a>
<span class="sourceLineNo">069</span><a name="line.69"></a>
<span class="sourceLineNo">070</span>  String path;<a name="line.70"></a>
<span class="sourceLineNo">071</span><a name="line.71"></a>
<span class="sourceLineNo">072</span>  boolean allPaths;<a name="line.72"></a>
<span class="sourceLineNo">073</span><a name="line.73"></a>
<span class="sourceLineNo">074</span>  boolean allValues;<a name="line.74"></a>
<span class="sourceLineNo">075</span><a name="line.75"></a>
<span class="sourceLineNo">076</span>  boolean uniqueValues;<a name="line.76"></a>
<span class="sourceLineNo">077</span><a name="line.77"></a>
<span class="sourceLineNo">078</span>  boolean pathChecked = false;<a name="line.78"></a>
<span class="sourceLineNo">079</span><a name="line.79"></a>
<span class="sourceLineNo">080</span>  TypeSystem typeSystem;<a name="line.80"></a>
<span class="sourceLineNo">081</span><a name="line.81"></a>
<span class="sourceLineNo">082</span>  Logger logger = Logger.getLogger(TypePathExtractor.class.getName());<a name="line.82"></a>
<span class="sourceLineNo">083</span><a name="line.83"></a>
<span class="sourceLineNo">084</span>  /**<a name="line.84"></a>
<span class="sourceLineNo">085</span>   * This extractor creates features from attributes of an annotation. For example, if you had a<a name="line.85"></a>
<span class="sourceLineNo">086</span>   * type called Token with an attribute called 'pos' you could use this extractor to extract a pos<a name="line.86"></a>
<span class="sourceLineNo">087</span>   * attribute for tokens. This would be done by calling the constructor with the values "pos",<a name="line.87"></a>
<span class="sourceLineNo">088</span>   * "pos", false, and false.<a name="line.88"></a>
<span class="sourceLineNo">089</span>   * <a name="line.89"></a>
<span class="sourceLineNo">090</span>   * The value you want may be nested within the type structure of the annotation that is being<a name="line.90"></a>
<span class="sourceLineNo">091</span>   * examined. For example, if you might have a type called 'NamedEntity' that has an attribute of<a name="line.91"></a>
<span class="sourceLineNo">092</span>   * type 'ResourceEntry' that has an attribute of type 'DbRecord' that has a String attribute<a name="line.92"></a>
<span class="sourceLineNo">093</span>   * called 'identifier'. You may want to extract the value of the identifier as a feature of the<a name="line.93"></a>
<span class="sourceLineNo">094</span>   * NamedEntity annotation. This could be done by calling the constructor with the values<a name="line.94"></a>
<span class="sourceLineNo">095</span>   * "identifier", "resourceEntry/dbRecord/identifier", false, and false (or something similar).<a name="line.95"></a>
<span class="sourceLineNo">096</span>   * <a name="line.96"></a>
<span class="sourceLineNo">097</span>   * The value you want for your featured may be multi-valued<a name="line.97"></a>
<span class="sourceLineNo">098</span>   * <a name="line.98"></a>
<span class="sourceLineNo">099</span>   * @param focusClass<a name="line.99"></a>
<span class="sourceLineNo">100</span>   *          the type of annotation that you are doing feature extraction on.<a name="line.100"></a>
<span class="sourceLineNo">101</span>   * @param typePath<a name="line.101"></a>
<span class="sourceLineNo">102</span>   *          a string representation of the path that should be traversed to extract a feature<a name="line.102"></a>
<span class="sourceLineNo">103</span>   *          value (e.g. "resourceEntry/dbRecord/identifier" or "pos" from the examples above.)<a name="line.103"></a>
<span class="sourceLineNo">104</span>   * @param traverseAllPaths<a name="line.104"></a>
<span class="sourceLineNo">105</span>   *          The path you traverse to the value you are trying to retrieve may include attributes<a name="line.105"></a>
<span class="sourceLineNo">106</span>   *          that have multiple-values. If true, then all paths are examined and features for each<a name="line.106"></a>
<span class="sourceLineNo">107</span>   *          traversal are added if possible. If false, then the first path that results in a<a name="line.107"></a>
<span class="sourceLineNo">108</span>   *          non-null value will be examined.<a name="line.108"></a>
<span class="sourceLineNo">109</span>   * @param returnAllValues<a name="line.109"></a>
<span class="sourceLineNo">110</span>   *          The last node of the path may be multi-valued. If true, then all values found in the<a name="line.110"></a>
<span class="sourceLineNo">111</span>   *          last node will be returned as features. If false, then only the first value of the<a name="line.111"></a>
<span class="sourceLineNo">112</span>   *          last node is returned. If traverseAllPaths and returnAllValues are both false, then a<a name="line.112"></a>
<span class="sourceLineNo">113</span>   *          list of size 0 or 1 will be returned. The other three combinations are each valid and<a name="line.113"></a>
<span class="sourceLineNo">114</span>   *          may return a list of size 0 or greater.<a name="line.114"></a>
<span class="sourceLineNo">115</span>   * @param uniqueValues<a name="line.115"></a>
<span class="sourceLineNo">116</span>   *          if true, then the returned values of the extract method will be unique.<a name="line.116"></a>
<span class="sourceLineNo">117</span>   */<a name="line.117"></a>
<span class="sourceLineNo">118</span><a name="line.118"></a>
<span class="sourceLineNo">119</span>  public TypePathExtractor(<a name="line.119"></a>
<span class="sourceLineNo">120</span>      Class&lt;? extends Annotation&gt; focusClass,<a name="line.120"></a>
<span class="sourceLineNo">121</span>      String typePath,<a name="line.121"></a>
<span class="sourceLineNo">122</span>      boolean traverseAllPaths,<a name="line.122"></a>
<span class="sourceLineNo">123</span>      boolean returnAllValues,<a name="line.123"></a>
<span class="sourceLineNo">124</span>      boolean uniqueValues) {<a name="line.124"></a>
<span class="sourceLineNo">125</span>    this.focusClass = focusClass;<a name="line.125"></a>
<span class="sourceLineNo">126</span>    this.path = typePath;<a name="line.126"></a>
<span class="sourceLineNo">127</span>    this.allPaths = traverseAllPaths;<a name="line.127"></a>
<span class="sourceLineNo">128</span>    this.allValues = returnAllValues;<a name="line.128"></a>
<span class="sourceLineNo">129</span>    this.uniqueValues = uniqueValues;<a name="line.129"></a>
<span class="sourceLineNo">130</span>  }<a name="line.130"></a>
<span class="sourceLineNo">131</span><a name="line.131"></a>
<span class="sourceLineNo">132</span>  /**<a name="line.132"></a>
<span class="sourceLineNo">133</span>   * calls this(type, typePath, false, false, true, jCas)<a name="line.133"></a>
<span class="sourceLineNo">134</span>   */<a name="line.134"></a>
<span class="sourceLineNo">135</span>  public TypePathExtractor(Class&lt;? extends Annotation&gt; focusClass, String typePath) {<a name="line.135"></a>
<span class="sourceLineNo">136</span>    this(focusClass, typePath, false, false, true);<a name="line.136"></a>
<span class="sourceLineNo">137</span>  }<a name="line.137"></a>
<span class="sourceLineNo">138</span><a name="line.138"></a>
<span class="sourceLineNo">139</span>  public List&lt;org.cleartk.classifier.Feature&gt; extract(JCas view, Annotation focusAnnotation)<a name="line.139"></a>
<span class="sourceLineNo">140</span>      throws CleartkExtractorException {<a name="line.140"></a>
<span class="sourceLineNo">141</span>    if (this.type == null)<a name="line.141"></a>
<span class="sourceLineNo">142</span>      this.type = UIMAUtil.getCasType(view, this.focusClass);<a name="line.142"></a>
<span class="sourceLineNo">143</span><a name="line.143"></a>
<span class="sourceLineNo">144</span>    this.typeSystem = view.getTypeSystem();<a name="line.144"></a>
<span class="sourceLineNo">145</span><a name="line.145"></a>
<span class="sourceLineNo">146</span>    if (!isValidPath(view))<a name="line.146"></a>
<span class="sourceLineNo">147</span>      throw CleartkExtractorException.invalidTypePath(path, type);<a name="line.147"></a>
<span class="sourceLineNo">148</span><a name="line.148"></a>
<span class="sourceLineNo">149</span>    String[] pathMembers = path.split("/");<a name="line.149"></a>
<span class="sourceLineNo">150</span>    List&lt;Object&gt; pathValues = new ArrayList&lt;Object&gt;();<a name="line.150"></a>
<span class="sourceLineNo">151</span>    _extract(view, focusAnnotation, pathMembers, pathValues);<a name="line.151"></a>
<span class="sourceLineNo">152</span><a name="line.152"></a>
<span class="sourceLineNo">153</span>    List&lt;org.cleartk.classifier.Feature&gt; returnValues = new ArrayList&lt;org.cleartk.classifier.Feature&gt;();<a name="line.153"></a>
<span class="sourceLineNo">154</span>    Set&lt;Object&gt; values = new HashSet&lt;Object&gt;();<a name="line.154"></a>
<span class="sourceLineNo">155</span>    for (Object pathValue : pathValues) {<a name="line.155"></a>
<span class="sourceLineNo">156</span>      if (uniqueValues) {<a name="line.156"></a>
<span class="sourceLineNo">157</span>        if (!values.contains(pathValue)) {<a name="line.157"></a>
<span class="sourceLineNo">158</span>          org.cleartk.classifier.Feature feature = new org.cleartk.classifier.feature.TypePathFeature(<a name="line.158"></a>
<span class="sourceLineNo">159</span>              null,<a name="line.159"></a>
<span class="sourceLineNo">160</span>              pathValue,<a name="line.160"></a>
<span class="sourceLineNo">161</span>              this.path);<a name="line.161"></a>
<span class="sourceLineNo">162</span>          returnValues.add(feature);<a name="line.162"></a>
<span class="sourceLineNo">163</span>          values.add(pathValue);<a name="line.163"></a>
<span class="sourceLineNo">164</span>        }<a name="line.164"></a>
<span class="sourceLineNo">165</span>      } else {<a name="line.165"></a>
<span class="sourceLineNo">166</span>        org.cleartk.classifier.Feature feature = new org.cleartk.classifier.feature.TypePathFeature(<a name="line.166"></a>
<span class="sourceLineNo">167</span>            null,<a name="line.167"></a>
<span class="sourceLineNo">168</span>            pathValue,<a name="line.168"></a>
<span class="sourceLineNo">169</span>            this.path);<a name="line.169"></a>
<span class="sourceLineNo">170</span>        returnValues.add(feature);<a name="line.170"></a>
<span class="sourceLineNo">171</span>      }<a name="line.171"></a>
<span class="sourceLineNo">172</span>    }<a name="line.172"></a>
<span class="sourceLineNo">173</span><a name="line.173"></a>
<span class="sourceLineNo">174</span>    return returnValues;<a name="line.174"></a>
<span class="sourceLineNo">175</span>  }<a name="line.175"></a>
<span class="sourceLineNo">176</span><a name="line.176"></a>
<span class="sourceLineNo">177</span>  private void _extract(<a name="line.177"></a>
<span class="sourceLineNo">178</span>      JCas view,<a name="line.178"></a>
<span class="sourceLineNo">179</span>      FeatureStructure featureStructure,<a name="line.179"></a>
<span class="sourceLineNo">180</span>      String[] pathMembers,<a name="line.180"></a>
<span class="sourceLineNo">181</span>      List&lt;Object&gt; pathValues) throws CleartkExtractorException {<a name="line.181"></a>
<span class="sourceLineNo">182</span>    if (pathMembers.length == 1) {<a name="line.182"></a>
<span class="sourceLineNo">183</span>      Feature feature = featureStructure.getType().getFeatureByBaseName(pathMembers[0]);<a name="line.183"></a>
<span class="sourceLineNo">184</span>      if (feature == null) {<a name="line.184"></a>
<span class="sourceLineNo">185</span>        return;<a name="line.185"></a>
<span class="sourceLineNo">186</span>      }<a name="line.186"></a>
<span class="sourceLineNo">187</span>      Type featureType = feature.getRange();<a name="line.187"></a>
<span class="sourceLineNo">188</span>      if (featureType.isPrimitive()) {<a name="line.188"></a>
<span class="sourceLineNo">189</span>        Object pathValue = getPrimitiveFeatureValue(view, featureStructure, feature);<a name="line.189"></a>
<span class="sourceLineNo">190</span>        if (pathValue != null)<a name="line.190"></a>
<span class="sourceLineNo">191</span>          pathValues.add(pathValue);<a name="line.191"></a>
<span class="sourceLineNo">192</span>      } else if (typeSystem.subsumes(typeSystem.getType("uima.tcas.Annotation"), featureType)) {<a name="line.192"></a>
<span class="sourceLineNo">193</span>        String coveredText = ((Annotation) featureStructure.getFeatureValue(feature)).getCoveredText();<a name="line.193"></a>
<span class="sourceLineNo">194</span>        if (coveredText != null)<a name="line.194"></a>
<span class="sourceLineNo">195</span>          pathValues.add(coveredText);<a name="line.195"></a>
<span class="sourceLineNo">196</span>      } else if (featureType.isArray()) {<a name="line.196"></a>
<span class="sourceLineNo">197</span>        Type componentType = featureType.getComponentType();<a name="line.197"></a>
<span class="sourceLineNo">198</span>        if (componentType.isPrimitive()) {<a name="line.198"></a>
<span class="sourceLineNo">199</span>          Object[] values = getPrimitiveArrayFeatureValue(view, featureStructure, feature);<a name="line.199"></a>
<span class="sourceLineNo">200</span>          if (allValues)<a name="line.200"></a>
<span class="sourceLineNo">201</span>            pathValues.addAll(Arrays.asList(values));<a name="line.201"></a>
<span class="sourceLineNo">202</span>          else if (values.length &gt; 0)<a name="line.202"></a>
<span class="sourceLineNo">203</span>            pathValues.add(values[0]);<a name="line.203"></a>
<span class="sourceLineNo">204</span>        } else if (typeSystem.subsumes(typeSystem.getType("uima.tcas.Annotation"), componentType)) {<a name="line.204"></a>
<span class="sourceLineNo">205</span>          ArrayFS fsArray = (ArrayFS) featureStructure.getFeatureValue(feature);<a name="line.205"></a>
<span class="sourceLineNo">206</span>          FeatureStructure[] array = fsArray.toArray();<a name="line.206"></a>
<span class="sourceLineNo">207</span>          if (allValues) {<a name="line.207"></a>
<span class="sourceLineNo">208</span>            for (FeatureStructure ftr : array)<a name="line.208"></a>
<span class="sourceLineNo">209</span>              pathValues.add(((Annotation) ftr).getCoveredText());<a name="line.209"></a>
<span class="sourceLineNo">210</span>          } else {<a name="line.210"></a>
<span class="sourceLineNo">211</span>            if (array.length &gt; 0)<a name="line.211"></a>
<span class="sourceLineNo">212</span>              pathValues.add(((Annotation) array[0]).getCoveredText());<a name="line.212"></a>
<span class="sourceLineNo">213</span>          }<a name="line.213"></a>
<span class="sourceLineNo">214</span>        }<a name="line.214"></a>
<span class="sourceLineNo">215</span>      }<a name="line.215"></a>
<span class="sourceLineNo">216</span>      // TODO else if type is a List type<a name="line.216"></a>
<span class="sourceLineNo">217</span>    } else {<a name="line.217"></a>
<span class="sourceLineNo">218</span>      String[] remainingPathMembers = new String[pathMembers.length - 1];<a name="line.218"></a>
<span class="sourceLineNo">219</span>      System.arraycopy(pathMembers, 1, remainingPathMembers, 0, pathMembers.length - 1);<a name="line.219"></a>
<span class="sourceLineNo">220</span><a name="line.220"></a>
<span class="sourceLineNo">221</span>      Feature feature = featureStructure.getType().getFeatureByBaseName(pathMembers[0]);<a name="line.221"></a>
<span class="sourceLineNo">222</span>      FeatureStructure featureValue = featureStructure.getFeatureValue(feature);<a name="line.222"></a>
<span class="sourceLineNo">223</span>      if (featureValue == null)<a name="line.223"></a>
<span class="sourceLineNo">224</span>        return;<a name="line.224"></a>
<span class="sourceLineNo">225</span>      if (featureValue instanceof FSArray) {<a name="line.225"></a>
<span class="sourceLineNo">226</span>        FSArray fsArray = (FSArray) featureValue;<a name="line.226"></a>
<span class="sourceLineNo">227</span>        if (allPaths) {<a name="line.227"></a>
<span class="sourceLineNo">228</span>          for (int i = 0; i &lt; fsArray.size(); i++) {<a name="line.228"></a>
<span class="sourceLineNo">229</span>            FeatureStructure fs = fsArray.get(i);<a name="line.229"></a>
<span class="sourceLineNo">230</span>            _extract(view, fs, remainingPathMembers, pathValues);<a name="line.230"></a>
<span class="sourceLineNo">231</span>          }<a name="line.231"></a>
<span class="sourceLineNo">232</span>        } else {<a name="line.232"></a>
<span class="sourceLineNo">233</span>          if (fsArray.size() &gt; 0)<a name="line.233"></a>
<span class="sourceLineNo">234</span>            _extract(view, fsArray.get(0), remainingPathMembers, pathValues);<a name="line.234"></a>
<span class="sourceLineNo">235</span>        }<a name="line.235"></a>
<span class="sourceLineNo">236</span>      }<a name="line.236"></a>
<span class="sourceLineNo">237</span>      // TODO else if(featureValue instanceof FSList)<a name="line.237"></a>
<span class="sourceLineNo">238</span>      else {<a name="line.238"></a>
<span class="sourceLineNo">239</span>        _extract(view, featureValue, remainingPathMembers, pathValues);<a name="line.239"></a>
<span class="sourceLineNo">240</span>      }<a name="line.240"></a>
<span class="sourceLineNo">241</span>    }<a name="line.241"></a>
<span class="sourceLineNo">242</span>  }<a name="line.242"></a>
<span class="sourceLineNo">243</span><a name="line.243"></a>
<span class="sourceLineNo">244</span>  private boolean isValidPath(JCas view) {<a name="line.244"></a>
<span class="sourceLineNo">245</span>    if (!pathChecked) {<a name="line.245"></a>
<span class="sourceLineNo">246</span>      boolean validPath = isValidPath(type, path, view);<a name="line.246"></a>
<span class="sourceLineNo">247</span>      if (validPath)<a name="line.247"></a>
<span class="sourceLineNo">248</span>        pathChecked = true;<a name="line.248"></a>
<span class="sourceLineNo">249</span>      return validPath;<a name="line.249"></a>
<span class="sourceLineNo">250</span>    } else<a name="line.250"></a>
<span class="sourceLineNo">251</span>      return true;<a name="line.251"></a>
<span class="sourceLineNo">252</span>  }<a name="line.252"></a>
<span class="sourceLineNo">253</span><a name="line.253"></a>
<span class="sourceLineNo">254</span>  // TODO should be possible to just get the Feature from the type system and<a name="line.254"></a>
<span class="sourceLineNo">255</span>  // return<a name="line.255"></a>
<span class="sourceLineNo">256</span>  // true if it is not null.<a name="line.256"></a>
<span class="sourceLineNo">257</span>  public static boolean isValidPath(Type type, String path, JCas view) {<a name="line.257"></a>
<span class="sourceLineNo">258</span>    String[] pathMembers = path.split("/");<a name="line.258"></a>
<span class="sourceLineNo">259</span>    Type pathMemberType = type; // will be set to type of last path member<a name="line.259"></a>
<span class="sourceLineNo">260</span>    // feature type<a name="line.260"></a>
<span class="sourceLineNo">261</span>    for (String pathMember : pathMembers) {<a name="line.261"></a>
<span class="sourceLineNo">262</span>      Feature feature = pathMemberType.getFeatureByBaseName(pathMember);<a name="line.262"></a>
<span class="sourceLineNo">263</span>      if (feature == null) {<a name="line.263"></a>
<span class="sourceLineNo">264</span>        return false;<a name="line.264"></a>
<span class="sourceLineNo">265</span>      }<a name="line.265"></a>
<span class="sourceLineNo">266</span>      pathMemberType = feature.getRange();<a name="line.266"></a>
<span class="sourceLineNo">267</span>      if (pathMemberType.isArray())<a name="line.267"></a>
<span class="sourceLineNo">268</span>        pathMemberType = pathMemberType.getComponentType();<a name="line.268"></a>
<span class="sourceLineNo">269</span>    }<a name="line.269"></a>
<span class="sourceLineNo">270</span>    return isValidType(pathMemberType, view.getTypeSystem());<a name="line.270"></a>
<span class="sourceLineNo">271</span>  }<a name="line.271"></a>
<span class="sourceLineNo">272</span><a name="line.272"></a>
<span class="sourceLineNo">273</span>  private static final String[] HANDLED_TYPES = new String[] {<a name="line.273"></a>
<span class="sourceLineNo">274</span>      "uima.cas.Boolean",<a name="line.274"></a>
<span class="sourceLineNo">275</span>      "uima.cas.BooleanArray",<a name="line.275"></a>
<span class="sourceLineNo">276</span>      "uima.cas.Byte",<a name="line.276"></a>
<span class="sourceLineNo">277</span>      "uima.cas.ByteArray",<a name="line.277"></a>
<span class="sourceLineNo">278</span>      "uima.cas.Double",<a name="line.278"></a>
<span class="sourceLineNo">279</span>      "uima.cas.DoubleArray",<a name="line.279"></a>
<span class="sourceLineNo">280</span>      "uima.cas.Float",<a name="line.280"></a>
<span class="sourceLineNo">281</span>      "uima.cas.FloatArray",<a name="line.281"></a>
<span class="sourceLineNo">282</span>      "uima.cas.FloatList",<a name="line.282"></a>
<span class="sourceLineNo">283</span>      "uima.cas.Integer",<a name="line.283"></a>
<span class="sourceLineNo">284</span>      "uima.cas.IntegerArray",<a name="line.284"></a>
<span class="sourceLineNo">285</span>      "uima.cas.IntegerList",<a name="line.285"></a>
<span class="sourceLineNo">286</span>      "uima.cas.Long",<a name="line.286"></a>
<span class="sourceLineNo">287</span>      "uima.cas.LongArray",<a name="line.287"></a>
<span class="sourceLineNo">288</span>      "uima.cas.Short",<a name="line.288"></a>
<span class="sourceLineNo">289</span>      "uima.cas.ShortArray",<a name="line.289"></a>
<span class="sourceLineNo">290</span>      "uima.cas.String",<a name="line.290"></a>
<span class="sourceLineNo">291</span>      "uima.cas.StringArray",<a name="line.291"></a>
<span class="sourceLineNo">292</span>      "uima.cas.StringList",<a name="line.292"></a>
<span class="sourceLineNo">293</span>      "uima.tcas.Annotation" };<a name="line.293"></a>
<span class="sourceLineNo">294</span><a name="line.294"></a>
<span class="sourceLineNo">295</span>  public static boolean isValidType(Type type, TypeSystem typeSystem) {<a name="line.295"></a>
<span class="sourceLineNo">296</span>    String typeName = type.getName();<a name="line.296"></a>
<span class="sourceLineNo">297</span>    for (String handledType : HANDLED_TYPES) {<a name="line.297"></a>
<span class="sourceLineNo">298</span>      if (typeName.equals(handledType))<a name="line.298"></a>
<span class="sourceLineNo">299</span>        return true;<a name="line.299"></a>
<span class="sourceLineNo">300</span>    }<a name="line.300"></a>
<span class="sourceLineNo">301</span><a name="line.301"></a>
<span class="sourceLineNo">302</span>    // see section 2.3.4 of UIMA References<a name="line.302"></a>
<span class="sourceLineNo">303</span>    if (typeSystem.subsumes(typeSystem.getType("uima.cas.String"), type))<a name="line.303"></a>
<span class="sourceLineNo">304</span>      return true;<a name="line.304"></a>
<span class="sourceLineNo">305</span>    if (typeSystem.subsumes(typeSystem.getType("uima.tcas.Annotation"), type))<a name="line.305"></a>
<span class="sourceLineNo">306</span>      return true;<a name="line.306"></a>
<span class="sourceLineNo">307</span><a name="line.307"></a>
<span class="sourceLineNo">308</span>    return false;<a name="line.308"></a>
<span class="sourceLineNo">309</span>  }<a name="line.309"></a>
<span class="sourceLineNo">310</span><a name="line.310"></a>
<span class="sourceLineNo">311</span>  /**<a name="line.311"></a>
<span class="sourceLineNo">312</span>   * see section 4.2.1 of the UIMA References documentation.<a name="line.312"></a>
<span class="sourceLineNo">313</span>   * <a name="line.313"></a>
<span class="sourceLineNo">314</span>   * @param view<a name="line.314"></a>
<span class="sourceLineNo">315</span>   * @param featureStructure<a name="line.315"></a>
<span class="sourceLineNo">316</span>   * @param feature<a name="line.316"></a>
<span class="sourceLineNo">317</span>   * @return The feature value.<a name="line.317"></a>
<span class="sourceLineNo">318</span>   */<a name="line.318"></a>
<span class="sourceLineNo">319</span>  private static Object getPrimitiveFeatureValue(<a name="line.319"></a>
<span class="sourceLineNo">320</span>      JCas view,<a name="line.320"></a>
<span class="sourceLineNo">321</span>      FeatureStructure featureStructure,<a name="line.321"></a>
<span class="sourceLineNo">322</span>      Feature feature) throws CleartkExtractorException {<a name="line.322"></a>
<span class="sourceLineNo">323</span>    TypeSystem typeSystem = view.getTypeSystem();<a name="line.323"></a>
<span class="sourceLineNo">324</span>    Type type = feature.getRange();<a name="line.324"></a>
<span class="sourceLineNo">325</span>    if (type.equals(typeSystem.getType("uima.cas.Boolean")))<a name="line.325"></a>
<span class="sourceLineNo">326</span>      return featureStructure.getBooleanValue(feature);<a name="line.326"></a>
<span class="sourceLineNo">327</span>    else if (type.equals(typeSystem.getType("uima.cas.Double")))<a name="line.327"></a>
<span class="sourceLineNo">328</span>      return featureStructure.getDoubleValue(feature);<a name="line.328"></a>
<span class="sourceLineNo">329</span>    else if (type.equals(typeSystem.getType("uima.cas.Float")))<a name="line.329"></a>
<span class="sourceLineNo">330</span>      return featureStructure.getFloatValue(feature);<a name="line.330"></a>
<span class="sourceLineNo">331</span>    else if (type.equals(typeSystem.getType("uima.cas.Byte")))<a name="line.331"></a>
<span class="sourceLineNo">332</span>      return featureStructure.getByteValue(feature);<a name="line.332"></a>
<span class="sourceLineNo">333</span>    else if (type.equals(typeSystem.getType("uima.cas.Short")))<a name="line.333"></a>
<span class="sourceLineNo">334</span>      return featureStructure.getShortValue(feature);<a name="line.334"></a>
<span class="sourceLineNo">335</span>    else if (type.equals(typeSystem.getType("uima.cas.Integer")))<a name="line.335"></a>
<span class="sourceLineNo">336</span>      return featureStructure.getIntValue(feature);<a name="line.336"></a>
<span class="sourceLineNo">337</span>    else if (type.equals(typeSystem.getType("uima.cas.Long")))<a name="line.337"></a>
<span class="sourceLineNo">338</span>      return featureStructure.getLongValue(feature);<a name="line.338"></a>
<span class="sourceLineNo">339</span>    else if (type.equals(typeSystem.getType("uima.cas.String")))<a name="line.339"></a>
<span class="sourceLineNo">340</span>      return featureStructure.getStringValue(feature);<a name="line.340"></a>
<span class="sourceLineNo">341</span>    else<a name="line.341"></a>
<span class="sourceLineNo">342</span>      throw CleartkExtractorException.notPrimitive(feature);<a name="line.342"></a>
<span class="sourceLineNo">343</span>  }<a name="line.343"></a>
<span class="sourceLineNo">344</span><a name="line.344"></a>
<span class="sourceLineNo">345</span>  private static Object[] getPrimitiveArrayFeatureValue(<a name="line.345"></a>
<span class="sourceLineNo">346</span>      JCas view,<a name="line.346"></a>
<span class="sourceLineNo">347</span>      FeatureStructure featureStructure,<a name="line.347"></a>
<span class="sourceLineNo">348</span>      Feature feature) throws CleartkExtractorException {<a name="line.348"></a>
<span class="sourceLineNo">349</span>    TypeSystem typeSystem = view.getTypeSystem();<a name="line.349"></a>
<span class="sourceLineNo">350</span>    Type type = feature.getRange();<a name="line.350"></a>
<span class="sourceLineNo">351</span>    if (type.isArray()) {<a name="line.351"></a>
<span class="sourceLineNo">352</span>      Type componentType = type.getComponentType();<a name="line.352"></a>
<span class="sourceLineNo">353</span>      FeatureStructure featureValue = featureStructure.getFeatureValue(feature);<a name="line.353"></a>
<span class="sourceLineNo">354</span>      if (componentType.equals(typeSystem.getType("uima.cas.String"))) {<a name="line.354"></a>
<span class="sourceLineNo">355</span>        return ((StringArray) featureValue).toArray();<a name="line.355"></a>
<span class="sourceLineNo">356</span>      } else if (componentType.equals(typeSystem.getType("uima.cas.Boolean"))) {<a name="line.356"></a>
<span class="sourceLineNo">357</span>        return Arrays.asList(((BooleanArray) featureValue).toArray()).toArray();<a name="line.357"></a>
<span class="sourceLineNo">358</span>      } else if (componentType.equals(typeSystem.getType("uima.cas.Double"))) {<a name="line.358"></a>
<span class="sourceLineNo">359</span>        return Arrays.asList(((DoubleArray) featureValue).toArray()).toArray();<a name="line.359"></a>
<span class="sourceLineNo">360</span>      } else if (componentType.equals(typeSystem.getType("uima.cas.Float"))) {<a name="line.360"></a>
<span class="sourceLineNo">361</span>        return Arrays.asList(((FloatArray) featureValue).toArray()).toArray();<a name="line.361"></a>
<span class="sourceLineNo">362</span>      } else if (componentType.equals(typeSystem.getType("uima.cas.Byte"))) {<a name="line.362"></a>
<span class="sourceLineNo">363</span>        return Arrays.asList(((ByteArray) featureValue).toArray()).toArray();<a name="line.363"></a>
<span class="sourceLineNo">364</span>      } else if (componentType.equals(typeSystem.getType("uima.cas.Short"))) {<a name="line.364"></a>
<span class="sourceLineNo">365</span>        return Arrays.asList(((ShortArray) featureValue).toArray()).toArray();<a name="line.365"></a>
<span class="sourceLineNo">366</span>      } else if (componentType.equals(typeSystem.getType("uima.cas.Integer"))) {<a name="line.366"></a>
<span class="sourceLineNo">367</span>        return Arrays.asList(((IntegerArray) featureValue).toArray()).toArray();<a name="line.367"></a>
<span class="sourceLineNo">368</span>      } else if (componentType.equals(typeSystem.getType("uima.cas.Long"))) {<a name="line.368"></a>
<span class="sourceLineNo">369</span>        return Arrays.asList(((LongArray) featureValue).toArray()).toArray();<a name="line.369"></a>
<span class="sourceLineNo">370</span>      }<a name="line.370"></a>
<span class="sourceLineNo">371</span>    } else<a name="line.371"></a>
<span class="sourceLineNo">372</span>      throw CleartkExtractorException.notPrimitiveArray(feature);<a name="line.372"></a>
<span class="sourceLineNo">373</span>    return null;<a name="line.373"></a>
<span class="sourceLineNo">374</span>  }<a name="line.374"></a>
<span class="sourceLineNo">375</span><a name="line.375"></a>
<span class="sourceLineNo">376</span>  public boolean isAllPaths() {<a name="line.376"></a>
<span class="sourceLineNo">377</span>    return allPaths;<a name="line.377"></a>
<span class="sourceLineNo">378</span>  }<a name="line.378"></a>
<span class="sourceLineNo">379</span><a name="line.379"></a>
<span class="sourceLineNo">380</span>  public boolean isAllValues() {<a name="line.380"></a>
<span class="sourceLineNo">381</span>    return allValues;<a name="line.381"></a>
<span class="sourceLineNo">382</span>  }<a name="line.382"></a>
<span class="sourceLineNo">383</span><a name="line.383"></a>
<span class="sourceLineNo">384</span>  public Class&lt;? extends Annotation&gt; getFocusClass() {<a name="line.384"></a>
<span class="sourceLineNo">385</span>    return focusClass;<a name="line.385"></a>
<span class="sourceLineNo">386</span>  }<a name="line.386"></a>
<span class="sourceLineNo">387</span><a name="line.387"></a>
<span class="sourceLineNo">388</span>  public String getPath() {<a name="line.388"></a>
<span class="sourceLineNo">389</span>    return path;<a name="line.389"></a>
<span class="sourceLineNo">390</span>  }<a name="line.390"></a>
<span class="sourceLineNo">391</span><a name="line.391"></a>
<span class="sourceLineNo">392</span>  public boolean isUniqueValues() {<a name="line.392"></a>
<span class="sourceLineNo">393</span>    return uniqueValues;<a name="line.393"></a>
<span class="sourceLineNo">394</span>  }<a name="line.394"></a>
<span class="sourceLineNo">395</span><a name="line.395"></a>
<span class="sourceLineNo">396</span>}<a name="line.396"></a>




























































</pre>
</div>
</body>
</html>
